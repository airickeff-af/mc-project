<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="description" content="MC Project - Kairosoft Style Health & Wealth Tracker with VRM Character">
    <meta name="theme-color" content="#2d1b4e">
    <title>üéÆ MC Project | Kairosoft Life Sim</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@pixiv/three-vrm@0.6.7/lib/three-vrm.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --pixel-bg: #1a1a2e;
            --pixel-dark: #0f0f1a;
            --pixel-cyan: #00d4ff;
            --pixel-purple: #9d4edd;
            --pixel-yellow: #ffe66d;
            --pixel-pink: #ff6b9d;
            --pixel-green: #4ecdc4;
            --pixel-gold: #ffd700;
            --pixel-orange: #ff8c42;
            --font-pixel: 'Press Start 2P', cursive;
            --font-terminal: 'VT323', monospace;
        }

        /* P1-030: Light Mode Theme */
        [data-theme="light"] {
            --pixel-bg: #f0f0f5;
            --pixel-dark: #e0e0e8;
            --pixel-cyan: #0088aa;
            --pixel-purple: #7b2cbf;
        }

        [data-theme="light"] body {
            color: #1a1a2e;
        }

        [data-theme="light"] .pixel-header {
            background: linear-gradient(180deg, #e0e0f0 0%, #d0d0e0 100%);
            border-bottom-color: var(--pixel-cyan);
        }

        [data-theme="light"] .pixel-card {
            background: linear-gradient(135deg, #ffffff, #f0f0f5);
            border-color: #ccc;
            box-shadow: 8px 8px 0 #bbb;
        }

        body {
            font-family: var(--font-terminal);
            background: var(--pixel-bg);
            color: #e0e0e0;
            min-height: 100vh;
            overflow-x: hidden;
            image-rendering: pixelated;
        }

        /* Kairosoft Pixel Header */
        .pixel-header {
            background: linear-gradient(180deg, #2d1b4e 0%, #1a1a2e 100%);
            border-bottom: 4px solid var(--pixel-cyan);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 0 #000;
            position: relative;
        }

        .pixel-header::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 0;
            right: 0;
            height: 4px;
            background: repeating-linear-gradient(90deg, var(--pixel-cyan) 0px, var(--pixel-cyan) 4px, transparent 4px, transparent 8px);
        }

        .pixel-logo {
            font-family: var(--font-pixel);
            font-size: 14px;
            color: var(--pixel-cyan);
            text-shadow: 2px 2px 0 #000, 0 0 10px var(--pixel-cyan);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .pixel-logo::before {
            content: 'üéÆ';
            font-size: 20px;
        }

        .pixel-nav {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .pixel-nav a {
            font-family: var(--font-pixel);
            font-size: 8px;
            color: #888;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border: 2px solid #333;
            background: var(--pixel-dark);
            transition: all 0.2s;
            box-shadow: 2px 2px 0 #000;
        }

        .pixel-nav a:hover, .pixel-nav a.active {
            color: var(--pixel-cyan);
            border-color: var(--pixel-cyan);
            background: rgba(0,212,255,0.1);
            transform: translate(-1px, -1px);
            box-shadow: 3px 3px 0 #000;
        }

        /* Main Layout - Kairosoft Style */
        .main-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        @media (max-width: 900px) {
            .main-container {
                grid-template-columns: 1fr;
            }
            
            /* P1-022: Mobile touch controls */
            #character-canvas {
                height: 300px;
                touch-action: pan-y pinch-zoom;
            }
            
            .pixel-header {
                flex-direction: column;
                gap: 0.5rem;
                padding: 0.5rem;
            }
            
            .pixel-nav {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .pixel-nav a, .pixel-btn {
                font-size: 6px;
                padding: 0.4rem 0.6rem;
            }
            
            .viewer-controls {
                gap: 0.3rem;
            }
            
            .pixel-card {
                padding: 1rem;
            }
        }
        
        @media (max-width: 600px) {
            #character-canvas {
                height: 250px;
            }
            
            .pixel-logo {
                font-size: 10px;
            }
            
            .level-badge, .stage-label {
                font-size: 8px;
                padding: 0.3rem 0.6rem;
            }
        }

        /* Character Viewer Section */
        .viewer-section {
            background: linear-gradient(135deg, #2d1b4e, #1a1a2e);
            border: 4px solid #333;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 8px 8px 0 #000;
            position: relative;
        }

        .viewer-title {
            font-family: var(--font-pixel);
            font-size: 10px;
            color: var(--pixel-yellow);
            margin-bottom: 1rem;
            text-align: center;
            text-shadow: 2px 2px 0 #000;
        }

        #character-canvas {
            width: 100%;
            height: 400px;
            background: linear-gradient(180deg, #1a1a2e, #0f0f1a);
            border: 2px solid #333;
            border-radius: 4px;
            cursor: pointer;
        }

        .character-overlay {
            position: absolute;
            top: 3rem;
            left: 1.5rem;
            right: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            pointer-events: none;
        }

        .level-badge {
            background: linear-gradient(135deg, var(--pixel-cyan), #0099cc);
            color: #000;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-family: var(--font-pixel);
            font-size: 10px;
            box-shadow: 0 4px 15px rgba(0, 212, 255, 0.4);
            animation: pulse 2s infinite;
            border: 2px solid #000;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .stage-label {
            background: rgba(0, 0, 0, 0.7);
            color: var(--pixel-cyan);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-family: var(--font-pixel);
            font-size: 8px;
            border: 2px solid var(--pixel-cyan);
        }

        .movement-indicator {
            position: absolute;
            bottom: 5rem;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid var(--pixel-cyan);
            border-radius: 20px;
            padding: 0.5rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 14px;
            color: var(--pixel-cyan);
            pointer-events: none;
            font-family: var(--font-pixel);
            font-size: 8px;
        }

        .viewer-controls {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .pixel-btn {
            font-family: var(--font-pixel);
            font-size: 8px;
            padding: 0.75rem 1rem;
            border: 2px solid var(--pixel-cyan);
            background: rgba(0,212,255,0.1);
            color: var(--pixel-cyan);
            cursor: pointer;
            transition: all 0.1s;
            box-shadow: 2px 2px 0 #000;
            position: relative;
            overflow: hidden;
        }

        .pixel-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.3s, height 0.3s;
        }

        .pixel-btn:active::before {
            width: 200%;
            height: 200%;
        }

        .pixel-btn:hover {
            background: var(--pixel-cyan);
            color: #000;
            transform: translate(-1px, -1px);
            box-shadow: 3px 3px 0 #000;
        }

        .pixel-btn:active {
            transform: translate(1px, 1px);
            box-shadow: 1px 1px 0 #000;
            transition: all 0.05s;
        }

        /* P1-029: Button ripple effect */
        @keyframes btn-ripple {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0.5; }
            100% { transform: translate(-50%, -50%) scale(4); opacity: 0; }
        }

        .pixel-btn.meditate {
            border-color: var(--pixel-green);
            background: rgba(78, 205, 196, 0.1);
            color: var(--pixel-green);
        }

        .pixel-btn.meditate:hover {
            background: var(--pixel-green);
            color: #000;
        }

        .pixel-btn.meditate.active {
            background: var(--pixel-green);
            color: #000;
            box-shadow: 0 0 15px var(--pixel-green);
        }

        .pixel-btn.holiday {
            border-color: var(--pixel-pink);
            background: rgba(255, 107, 157, 0.1);
            color: var(--pixel-pink);
        }

        .pixel-btn.holiday:hover {
            background: var(--pixel-pink);
            color: #000;
        }

        /* Holiday Menu */
        .holiday-menu {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #2d1b4e, #1a1a2e);
            border: 3px solid var(--pixel-pink);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 0.5rem;
            z-index: 100;
            box-shadow: 4px 4px 0 #000;
            display: none;
        }

        .holiday-menu.active {
            display: block;
            animation: slideDown 0.2s ease;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .holiday-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
            font-family: var(--font-pixel);
            font-size: 8px;
        }

        .holiday-option:hover {
            background: rgba(255, 107, 157, 0.2);
        }

        .holiday-option.active {
            background: var(--pixel-pink);
            color: #000;
        }

        /* P1-024: Color Menu */
        .color-menu {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #2d1b4e, #1a1a2e);
            border: 3px solid var(--pixel-cyan);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 0.5rem;
            z-index: 100;
            box-shadow: 4px 4px 0 #000;
            display: none;
        }

        .color-menu.active {
            display: block;
            animation: slideDown 0.2s ease;
        }

        .color-option {
            display: inline-block;
            width: 40px;
            height: 40px;
            margin: 0.25rem;
            border: 3px solid #333;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .color-option:hover {
            transform: scale(1.1);
            border-color: #fff;
        }

        .color-option.active {
            border-color: var(--pixel-cyan);
            box-shadow: 0 0 10px var(--pixel-cyan);
        }

        /* Stats Section */
        .stats-section {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .pixel-card {
            background: linear-gradient(135deg, #2d1b4e, #1a1a2e);
            border: 4px solid #333;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 8px 8px 0 #000;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }

        .pixel-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.5s;
        }

        .pixel-card:hover::before {
            left: 100%;
        }

        .pixel-card:hover {
            border-color: var(--pixel-cyan);
            transform: translate(-2px, -2px);
            box-shadow: 10px 10px 0 #000;
        }

        .pixel-card:active {
            transform: translate(0, 0);
            box-shadow: 4px 4px 0 #000;
        }

        /* P1-029: Loading State */
        .pixel-card.loading {
            pointer-events: none;
            opacity: 0.7;
        }

        .pixel-card.loading::after {
            content: '‚è≥';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2rem;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: translate(-50%, -50%) rotate(0deg); }
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }

        .pixel-card-title {
            font-family: var(--font-pixel);
            font-size: 10px;
            color: var(--pixel-cyan);
            margin-bottom: 1rem;
            border-bottom: 2px solid #333;
            padding-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #333;
        }

        .stat-row:last-child {
            border-bottom: none;
        }

        .stat-label {
            font-size: 18px;
            color: #888;
        }

        .stat-value {
            font-family: var(--font-pixel);
            font-size: 10px;
            color: var(--pixel-yellow);
        }

        /* Progress Bars */
        .progress-container {
            margin-top: 0.5rem;
        }

        .pixel-progress {
            height: 20px;
            background: #0f0f1a;
            border: 2px solid #333;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .pixel-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--pixel-cyan), var(--pixel-green));
            transition: width 0.3s ease;
            position: relative;
        }

        .pixel-progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(90deg, transparent 0px, transparent 4px, rgba(0,0,0,0.2) 4px, rgba(0,0,0,0.2) 8px);
        }

        /* Growth Panel */
        .growth-panel {
            background: linear-gradient(135deg, #2d1b4e, #1a1a2e);
            border: 4px solid #333;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 8px 8px 0 #000;
            margin-top: 1rem;
        }

        .growth-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .growth-title {
            font-family: var(--font-pixel);
            font-size: 10px;
            color: var(--pixel-cyan);
        }

        .growth-score {
            font-family: var(--font-pixel);
            font-size: 8px;
            color: var(--pixel-yellow);
        }

        .level-markers {
            display: flex;
            justify-content: space-between;
            margin-top: 1rem;
            padding: 0 0.5rem;
        }

        .level-marker {
            text-align: center;
            font-size: 10px;
            color: #666;
            transition: all 0.3s;
            font-family: var(--font-pixel);
            font-size: 6px;
        }

        .level-marker.active {
            color: var(--pixel-cyan);
            transform: scale(1.2);
        }

        .level-marker.completed {
            color: var(--pixel-green);
        }

        .level-marker .marker-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #333;
            margin: 0 auto 0.25rem;
            border: 2px solid #555;
            transition: all 0.3s;
        }

        .level-marker.active .marker-dot {
            background: var(--pixel-cyan);
            border-color: var(--pixel-cyan);
            box-shadow: 0 0 10px var(--pixel-cyan);
        }

        .level-marker.completed .marker-dot {
            background: var(--pixel-green);
            border-color: var(--pixel-green);
        }

        /* Environment Panel */
        .environment-panel {
            background: linear-gradient(135deg, #2d1b4e, #1a1a2e);
            border: 4px solid #333;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 8px 8px 0 #000;
            margin-top: 1rem;
        }

        .env-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #333;
        }

        .env-row:last-of-type {
            border-bottom: none;
        }

        .env-label {
            color: #888;
            font-size: 16px;
        }

        .env-value {
            color: var(--pixel-cyan);
            font-weight: 600;
            font-size: 14px;
            font-family: var(--font-pixel);
            font-size: 8px;
        }

        .env-items {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid #333;
        }

        .env-item {
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid var(--pixel-cyan);
            border-radius: 12px;
            padding: 0.25rem 0.75rem;
            font-size: 12px;
            color: var(--pixel-cyan);
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
            padding: 20px;
        }

        .modal-overlay.active { display: flex; }

        .modal-content {
            background: linear-gradient(135deg, #2d1b4e, #1a1a2e);
            border: 4px solid var(--pixel-cyan);
            border-radius: 8px;
            padding: 2rem;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 8px 8px 0 #000;
        }

        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: 2px solid #333;
            color: #888;
            font-size: 18px;
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: var(--font-pixel);
        }

        .modal-close:hover {
            color: var(--pixel-pink);
            border-color: var(--pixel-pink);
        }

        .modal-title {
            font-family: var(--font-pixel);
            font-size: 12px;
            color: var(--pixel-cyan);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .detail-grid {
            display: grid;
            gap: 0.75rem;
        }

        .detail-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 1rem;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 2px solid #333;
        }

        .detail-label { color: #888; font-size: 16px; }
        .detail-value {
            font-family: var(--font-pixel);
            font-size: 10px;
            color: var(--pixel-yellow);
        }

        .input-section {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 2px solid #333;
        }

        .input-section h3 {
            font-family: var(--font-pixel);
            font-size: 10px;
            color: var(--pixel-cyan);
            margin-bottom: 1rem;
        }

        .input-row {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            flex-wrap: wrap;
        }

        .pixel-input, .pixel-select {
            flex: 1;
            padding: 0.75rem;
            background: #0f0f1a;
            border: 2px solid #333;
            border-radius: 4px;
            color: #e0e0e0;
            font-family: var(--font-terminal);
            font-size: 16px;
            min-width: 100px;
        }

        .pixel-input:focus, .pixel-select:focus {
            outline: none;
            border-color: var(--pixel-cyan);
        }

        /* Confession Section */
        .confession-section {
            max-width: 800px;
            margin: 2rem auto;
            padding: 1.5rem;
            background: linear-gradient(135deg, #2d1b4e 0%, #1a1a2e 100%);
            border: 4px solid #333;
            border-radius: 8px;
            box-shadow: 8px 8px 0 #000;
        }

        .confession-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #333;
        }

        .confession-form {
            margin-bottom: 1.5rem;
        }

        .pixel-textarea {
            width: 100%;
            min-height: 100px;
            padding: 1rem;
            background: #0f0f1a;
            border: 2px solid #333;
            border-radius: 4px;
            color: #e0e0e0;
            font-family: var(--font-terminal);
            font-size: 16px;
            resize: vertical;
        }

        .pixel-textarea:focus {
            outline: none;
            border-color: var(--pixel-cyan);
        }

        .confession-meta {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .char-count {
            text-align: right;
            font-size: 12px;
            color: #666;
            margin-top: 0.5rem;
        }

        .confession-feed {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .confession-card {
            background: #0f0f1a;
            border: 2px solid #333;
            border-radius: 8px;
            padding: 1rem;
            transition: all 0.2s;
        }

        .confession-card:hover {
            border-color: var(--pixel-cyan);
            transform: translateX(4px);
        }

        .confession-category-tag {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-size: 12px;
            margin-bottom: 0.5rem;
            font-family: var(--font-pixel);
            font-size: 6px;
        }

        .confession-text {
            font-size: 14px;
            line-height: 1.6;
            color: #e0e0e0;
            margin-bottom: 1rem;
        }

        .confession-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: #666;
        }

        .confession-actions {
            display: flex;
            gap: 0.5rem;
        }

        .action-btn {
            background: transparent;
            border: 2px solid #333;
            border-radius: 4px;
            padding: 0.5rem 1rem;
            color: #888;
            font-family: var(--font-pixel);
            font-size: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .action-btn:hover {
            border-color: var(--pixel-cyan);
            color: var(--pixel-cyan);
        }

        .action-btn.liked {
            border-color: var(--pixel-pink);
            color: var(--pixel-pink);
            background: rgba(255, 107, 157, 0.1);
        }

        .winner-banner {
            background: linear-gradient(135deg, var(--pixel-gold) 0%, #ffed4e 100%);
            border: 3px solid var(--pixel-gold);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
            animation: winner-pulse 2s ease-in-out infinite;
        }

        @keyframes winner-pulse {
            0%, 100% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.3); }
            50% { box-shadow: 0 0 40px rgba(255, 215, 0, 0.6); }
        }

        .winner-banner.hidden { display: none; }

        .winner-crown {
            font-size: 2rem;
            animation: crown-bounce 1s ease-in-out infinite;
        }

        @keyframes crown-bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .winner-text {
            display: flex;
            flex-direction: column;
            color: #1a1a2e;
        }

        .winner-text strong {
            font-family: var(--font-pixel);
            font-size: 8px;
        }

        /* Challenge Section */
        .challenge-section {
            max-width: 800px;
            margin: 2rem auto;
            padding: 1.5rem;
            background: linear-gradient(135deg, #2d1b4e 0%, #1a1a2e 100%);
            border: 4px solid #333;
            border-radius: 8px;
            box-shadow: 8px 8px 0 #000;
        }

        .challenge-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #333;
        }

        .challenge-card {
            background: #0f0f1a;
            border: 2px solid #333;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: all 0.2s;
        }

        .challenge-card:hover {
            border-color: var(--pixel-cyan);
        }

        .challenge-card.winner {
            border-color: var(--pixel-gold);
            background: linear-gradient(135deg, #1a1a2e 0%, #2a2510 100%);
        }

        .challenge-title {
            font-family: var(--font-pixel);
            font-size: 10px;
            color: var(--pixel-cyan);
            margin-bottom: 0.5rem;
        }

        .challenge-progress-bar {
            height: 16px;
            background: #0a0a0f;
            border: 2px solid #333;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .challenge-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--pixel-cyan), var(--pixel-green));
            transition: width 0.3s ease;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--pixel-cyan);
            color: #0a0a0f;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            font-family: var(--font-pixel);
            font-size: 8px;
            z-index: 10000;
            box-shadow: 4px 4px 0 #000;
            animation: slide-in 0.3s ease;
            border: 2px solid #000;
        }

        @keyframes slide-in {
            from { transform: translateX(400px); }
            to { transform: translateX(0); }
        }

        /* Footer */
        .pixel-footer {
            text-align: center;
            padding: 2rem;
            border-top: 4px solid #333;
            margin-top: 2rem;
            font-size: 14px;
            color: #666;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(10, 10, 15, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            flex-direction: column;
            gap: 1rem;
        }

        .loading-overlay.hidden { display: none; }

        .pixel-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid #333;
            border-top-color: var(--pixel-cyan);
            animation: spin 1s steps(8) infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-family: var(--font-pixel);
            font-size: 10px;
            color: var(--pixel-cyan);
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="pixel-spinner"></div>
        <div class="loading-text">LOADING VRM #11318...</div>
    </div>

    <!-- Pixel Header -->
    <header class="pixel-header">
        <div class="pixel-logo">MC PROJECT</div>
        <nav class="pixel-nav">
            <a href="#character" class="active">CHARACTER</a>
            <a href="#health">HEALTH</a>
            <a href="#wealth">WEALTH</a>
            <a href="#quiz">QUIZ</a>
            <a href="#achievements">BADGES</a>
            <a href="#friends">FRIENDS</a>
            <a href="#confessions">CONFESSIONS</a>
            <a href="#challenges">CHALLENGES</a>
            <button class="pixel-btn" onclick="toggleTheme()" style="font-size: 8px; padding: 0.5rem;">üåì THEME</button>
            <button class="pixel-btn" onclick="SoundFX.toggle()" style="font-size: 8px; padding: 0.5rem;">üîä SOUND</button>
        </nav>
    </header>

    <!-- Main Container -->
    <div class="main-container">
        <!-- 3D Character Viewer -->
        <section class="viewer-section" id="character">
            <h2 class="viewer-title">üë§ YOUR CHARACTER</h2>
            <div style="position: relative;">
                <div id="character-canvas"></div>
                <div class="character-overlay">
                    <div class="level-badge">LVL <span id="currentLevel">4</span></div>
                    <div class="stage-label" id="stageLabel">üéì ADULT</div>
                </div>
                <div class="movement-indicator" id="movementIndicator">
                    <span>üé≠</span>
                    <span>IDLE</span>
                </div>
            </div>
            <div class="viewer-controls">
                <button class="pixel-btn" onclick="rotateCharacter()">üîÑ ROTATE</button>
                <button class="pixel-btn" onclick="toggleWireframe()">üî≤ WIREFRAME</button>
                <button class="pixel-btn" onclick="resetView()">üè† RESET</button>
                <button class="pixel-btn" onclick="randomPose()">üé≤ POSE</button>
                <button class="pixel-btn meditate" id="meditateBtn" onclick="toggleMeditation()">üßò MEDITATE</button>
                <button class="pixel-btn" onclick="exportReport()">üìä EXPORT</button>
                <button class="pixel-btn" onclick="shareToTwitter()">üì§ SHARE</button>
                <button class="pixel-btn" style="background: linear-gradient(135deg, #ff6b9d, #ff8fab);" onclick="toggleFullscreen()">‚õ∂ FULLSCREEN</button>
                <div style="position: relative; display: inline-block;">
                    <button class="pixel-btn holiday" id="holidayBtn" onclick="toggleHolidayMenu()">üéÑ HOLIDAY</button>
                    <button class="pixel-btn" onclick="toggleColorMenu()">üé® COLOR</button>
                    <div class="holiday-menu" id="holidayMenu">
                        <div class="holiday-option" data-holiday="newyear" onclick="selectHoliday('newyear')">üéÜ NEW YEAR (JAN)</div>
                        <div class="holiday-option" data-holiday="valentine" onclick="selectHoliday('valentine')">üíù VALENTINE'S (FEB)</div>
                        <div class="holiday-option" data-holiday="lunar" onclick="selectHoliday('lunar')">üßß LUNAR NEW YEAR (FEB)</div>
                        <div class="holiday-option" data-holiday="halloween" onclick="selectHoliday('halloween')">üéÉ HALLOWEEN (OCT)</div>
                        <div class="holiday-option" data-holiday="christmas" onclick="selectHoliday('christmas')">üéÑ CHRISTMAS (DEC)</div>
                        <div class="holiday-option" data-holiday="birthday" onclick="selectHoliday('birthday')">üéÇ BIRTHDAY</div>
                        <div class="holiday-option" data-holiday="none" onclick="selectHoliday('none')">‚ùå NO COSTUME</div>
                    </div>
                    <div class="color-menu" id="colorMenu">
                        <div class="color-option" style="background: #00d4ff;" onclick="setCharacterColor('#00d4ff')"></div>
                        <div class="color-option" style="background: #ff6b9d;" onclick="setCharacterColor('#ff6b9d')"></div>
                        <div class="color-option" style="background: #4ecdc4;" onclick="setCharacterColor('#4ecdc4')"></div>
                        <div class="color-option" style="background: #ffe66d;" onclick="setCharacterColor('#ffe66d')"></div>
                        <div class="color-option" style="background: #9d4edd;" onclick="setCharacterColor('#9d4edd')"></div>
                        <div class="color-option" style="background: #ff8c42;" onclick="setCharacterColor('#ff8c42')"></div>
                    </div>
                </div>
            </div>

            <!-- Growth Panel -->
            <div class="growth-panel">
                <div class="growth-header">
                    <div class="growth-title">üìà GROWTH</div>
                    <div class="growth-score">SCORE: <span id="growthScore">0</span>/100</div>
                </div>
                <div class="pixel-progress">
                    <div class="pixel-progress-fill" id="growthProgress" style="width: 0%"></div>
                </div>
                <div class="level-markers">
                    <div class="level-marker completed" data-level="1">
                        <div class="marker-dot"></div>
                        <div>üéì</div>
                        <div>ADULT</div>
                    </div>
                    <div class="level-marker completed" data-level="2">
                        <div class="marker-dot"></div>
                        <div>üéì</div>
                        <div>ADULT</div>
                    </div>
                    <div class="level-marker completed" data-level="3">
                        <div class="marker-dot"></div>
                        <div>üéì</div>
                        <div>ADULT</div>
                    </div>
                    <div class="level-marker active" data-level="4">
                        <div class="marker-dot"></div>
                        <div>üéì</div>
                        <div>ADULT</div>
                    </div>
                </div>
            </div>

            <!-- Environment Panel -->
            <div class="environment-panel">
                <h3 class="pixel-card-title">üè† ENVIRONMENT</h3>
                <div class="env-row">
                    <span class="env-label">Wealth Level:</span>
                    <span class="env-value" id="envWealth">SMALL ROOM</span>
                </div>
                <div class="env-row">
                    <span class="env-label">Health Level:</span>
                    <span class="env-value" id="envHealth">GLOOMY</span>
                </div>
                <div class="env-items" id="envItems">
                    <span class="env-item">üõèÔ∏è BASIC FLOOR</span>
                </div>
            </div>
        </section>

        <!-- Stats Section -->
        <div class="stats-section">
            <!-- Health Card -->
            <div class="pixel-card" id="health" onclick="openModal('health')">
                <h3 class="pixel-card-title">‚ù§Ô∏è HEALTH</h3>
                <div class="stat-row">
                    <span class="stat-label">Health Score</span>
                    <span class="stat-value" id="healthScoreValue">78</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Exercise Today</span>
                    <span class="stat-value">45 MIN</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Sleep Last Night</span>
                    <span class="stat-value">7.5 HRS</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Calories</span>
                    <span class="stat-value">1,850</span>
                </div>
                <div class="progress-container">
                    <div class="pixel-progress">
                        <div class="pixel-progress-fill" id="healthBar" style="width: 78%"></div>
                    </div>
                </div>
            </div>

            <!-- Wealth Card -->
            <div class="pixel-card" id="wealth" onclick="openModal('wealth')">
                <h3 class="pixel-card-title">üí∞ WEALTH</h3>
                <div class="stat-row">
                    <span class="stat-label">Wealth Score</span>
                    <span class="stat-value" id="wealthScoreValue">65</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Total Savings</span>
                    <span class="stat-value">$12,450</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Investments</span>
                    <span class="stat-value">$8,200</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Gig Earnings</span>
                    <span class="stat-value">$3,800</span>
                </div>
                <div class="progress-container">
                    <div class="pixel-progress">
                        <div class="pixel-progress-fill" id="wealthBar" style="width: 65%"></div>
                    </div>
                </div>
            </div>

            <!-- Streak Card -->
            <div class="pixel-card">
                <h3 class="pixel-card-title">üî• STREAK</h3>
                <div class="stat-row">
                    <span class="stat-label">Current Streak</span>
                    <span class="stat-value">12 DAYS</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Best Streak</span>
                    <span class="stat-value">28 DAYS</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Next Reward</span>
                    <span class="stat-value">3 DAYS</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Confession Section -->
    <section class="confession-section" id="confessions">
        <div class="confession-header">
            <h2 class="pixel-card-title">üì¢ DAILY CONFESSIONS</h2>
            <span style="font-family: var(--font-pixel); font-size: 8px; color: #888;">
                <span id="confessionCount">0</span> CONFESSIONS
            </span>
        </div>

        <!-- Submission Form -->
        <div class="confession-form">
            <textarea
                id="confessionInput"
                class="pixel-textarea"
                placeholder="Share your anonymous confession... What's on your mind?"
                maxlength="280"
            ></textarea>
            <div class="confession-meta">
                <select id="confessionCategory" class="pixel-select">
                    <option value="health">üí™ HEALTH</option>
                    <option value="wealth">üí∞ WEALTH</option>
                    <option value="mindset">üß† MINDSET</option>
                    <option value="relationship">‚ù§Ô∏è RELATIONSHIPS</option>
                    <option value="work">üíº WORK</option>
                </select>
                <button onclick="submitConfession()" class="pixel-btn primary">üöÄ POST</button>
            </div>
            <div class="char-count"><span id="charCount">0</span>/280</div>
        </div>

        <!-- Winner Banner -->
        <div id="winnerBanner" class="winner-banner hidden">
            <div class="winner-crown">üëë</div>
            <div class="winner-text">
                <strong>YESTERDAY'S WINNER!</strong>
                <span id="winnerConfession"></span>
            </div>
        </div>

        <!-- Confession Feed -->
        <div id="confessionFeed" class="confession-feed">
            <div style="text-align: center; padding: 2rem; color: #666; font-family: var(--font-pixel); font-size: 8px;">
                üìù NO CONFESSIONS YET. BE THE FIRST!
            </div>
        </div>
    </section>

    <!-- Achievements Section -->
    <section class="challenge-section" id="achievements">
        <div class="challenge-header">
            <h2 class="pixel-card-title">üèÜ ACHIEVEMENTS</h2>
            <span id="achievementCount" style="font-family: var(--font-pixel); font-size: 8px; color: #888;">0/10</span>
        </div>
        <div id="achievementsList" style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
            <!-- Achievements rendered here -->
        </div>
    </section>

    <!-- Friend Comparison Section -->
    <section class="challenge-section" id="friends">
        <div class="challenge-header">
            <h2 class="pixel-card-title">üë• FRIEND LEADERBOARD</h2>
        </div>
        <div id="friendLeaderboard">
            <div class="pixel-card" style="margin-bottom: 0.5rem;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>ü•á Alex</span>
                    <span style="color: var(--pixel-gold);">92 PTS</span>
                </div>
            </div>
            <div class="pixel-card" style="margin-bottom: 0.5rem; background: rgba(0,212,255,0.1); border-color: var(--pixel-cyan);">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>ü•à YOU</span>
                    <span style="color: var(--pixel-cyan);">${growthState.combinedScore} PTS</span>
                </div>
            </div>
            <div class="pixel-card" style="margin-bottom: 0.5rem;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>ü•â Sam</span>
                    <span style="color: var(--pixel-orange);">68 PTS</span>
                </div>
            </div>
        </div>
    </section>

    <!-- Daily Quiz Section -->
    <section class="challenge-section" id="quiz">
        <div class="challenge-header">
            <h2 class="pixel-card-title">‚ùì DAILY QUIZ</h2>
            <span id="quizStatus" style="font-family: var(--font-pixel); font-size: 8px; color: #888;">üîí NOT ATTEMPTED</span>
        </div>
        <div id="quizContainer">
            <div id="quizQuestion" class="pixel-card" style="margin-bottom: 1rem;">
                <p style="font-size: 16px; margin-bottom: 1rem;">üß† What is the 50/30/20 rule in budgeting?</p>
                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                    <button class="pixel-btn" onclick="answerQuiz('a')">A) 50% needs, 30% wants, 20% savings</button>
                    <button class="pixel-btn" onclick="answerQuiz('b')">B) 50% savings, 30% needs, 20% wants</button>
                    <button class="pixel-btn" onclick="answerQuiz('c')">C) 50% wants, 30% savings, 20% needs</button>
                </div>
            </div>
            <div id="quizResult" style="display: none; text-align: center; padding: 1rem;"></div>
        </div>
    </section>

    <!-- Challenge Section -->
    <section class="challenge-section" id="challenges">
        <div class="challenge-header">
            <h2 class="pixel-card-title">üèÜ FRIEND CHALLENGES</h2>
            <button onclick="showChallengeModal()" class="pixel-btn primary">‚ûï NEW</button>
        </div>

        <div id="challengeList">
            <div style="text-align: center; padding: 2rem; color: #666; font-family: var(--font-pixel); font-size: 8px;">
                üèÜ NO ACTIVE CHALLENGES. CREATE ONE!
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="pixel-footer">
        <p>üéÆ MC PROJECT - KAIROSOFT STYLE LIFE SIM</p>
        <p style="margin-top: 0.5rem; font-size: 12px;">VRM #11318 | HEALTH + WEALTH TRACKER</p>
    </footer>

    <!-- Health Detail Modal -->
    <div class="modal-overlay" id="healthModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('health')">√ó</button>
            <h2 class="modal-title">‚ù§Ô∏è HEALTH DETAILS</h2>
            <div class="detail-grid">
                <div class="detail-item">
                    <span class="detail-label">Overall Health Score</span>
                    <span class="detail-value" id="modalHealthScore">78/100</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Steps Today</span>
                    <span class="detail-value">4,247 / 10,000</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Sleep Last Night</span>
                    <span class="detail-value">7.5 hours</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Healthy Meals</span>
                    <span class="detail-value">3 of 5</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Mental Health</span>
                    <span class="detail-value">Good üòä</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Exercise Minutes</span>
                    <span class="detail-value">25 min</span>
                </div>
            </div>
            <div class="input-section">
                <h3>‚ûï LOG HEALTH ACTIVITY</h3>
                <div class="input-row">
                    <select class="pixel-select" id="healthActivityType">
                        <option value="steps">STEPS</option>
                        <option value="sleep">SLEEP (HRS)</option>
                        <option value="meal">HEALTHY MEAL</option>
                        <option value="exercise">EXERCISE (MIN)</option>
                    </select>
                    <input type="number" class="pixel-input" id="healthActivityValue" placeholder="VALUE">
                    <button onclick="logHealthActivity()" class="pixel-btn primary">ADD</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Wealth Detail Modal -->
    <div class="modal-overlay" id="wealthModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('wealth')">√ó</button>
            <h2 class="modal-title">üí∞ WEALTH DETAILS</h2>
            <div class="detail-grid">
                <div class="detail-item">
                    <span class="detail-label">Overall Wealth Score</span>
                    <span class="detail-value" id="modalWealthScore">65/100</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Total Savings</span>
                    <span class="detail-value">$12,450</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Investments</span>
                    <span class="detail-value">$8,200</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Gig Income (This Month)</span>
                    <span class="detail-value">$3,800</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Monthly Expenses</span>
                    <span class="detail-value">$2,100</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Debt</span>
                    <span class="detail-value">$0 üéâ</span>
                </div>
            </div>
            <div class="input-section">
                <h3>‚ûï LOG WEALTH ACTIVITY</h3>
                <div class="input-row">
                    <select class="pixel-select" id="wealthActivityType">
                        <option value="income">INCOME</option>
                        <option value="expense">EXPENSE</option>
                        <option value="investment">INVESTMENT</option>
                        <option value="gig">GIG WORK</option>
                    </select>
                    <input type="number" class="pixel-input" id="wealthActivityValue" placeholder="$ AMOUNT">
                    <button onclick="logWealthActivity()" class="pixel-btn primary">ADD</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Challenge Modal -->
    <div class="modal-overlay" id="challengeModal">
        <div class="modal-content">
            <button class="modal-close" onclick="hideChallengeModal()">√ó</button>
            <h2 class="modal-title">üèÜ CREATE CHALLENGE</h2>
            <div class="input-row" style="flex-direction: column;">
                <select class="pixel-select" id="challengeType">
                    <option value="steps">üëü STEP BATTLE</option>
                    <option value="savings">üí∞ SAVINGS RACE</option>
                    <option value="workout">üí™ WORKOUT STREAK</option>
                    <option value="sleep">üò¥ SLEEP GOAL</option>
                </select>
                <input type="text" class="pixel-input" id="challengeFriend" placeholder="FRIEND'S NAME">
                <input type="number" class="pixel-input" id="challengeGoal" placeholder="GOAL AMOUNT">
                <select class="pixel-select" id="challengeDuration">
                    <option value="1">1 DAY</option>
                    <option value="3">3 DAYS</option>
                    <option value="7" selected>7 DAYS</option>
                    <option value="30">30 DAYS</option>
                </select>
                <button onclick="createChallenge()" class="pixel-btn primary" style="width: 100%;">CREATE CHALLENGE</button>
            </div>
        </div>
    </div>

    <!-- Three.js Character Script -->
    <script>
        // ============================================
        // THREE.JS VRM CHARACTER WITH KAIROSOFT THEME
        // ============================================

        let scene, camera, renderer, character, controls;
        let isWireframe = false;
        let currentPose = 0;
        let poseInterval;
        let environmentObjects = [];
        let unlockedItems = new Set();

        // Growth State - DISABLED for VRM display fix
        const growthState = {
            level: 4, // Fixed at ADULT
            healthScore: 78,
            wealthScore: 65,
            combinedScore: 71,
            stage: 'adult'
        };

        // Level Configuration - ALL FIXED AT SCALE 1.0 (growth disabled)
        const LEVELS = {
            1: { name: 'ADULT', emoji: 'üéì', minScore: 0, maxScore: 100, scale: 1.0, next: 100 },
            2: { name: 'ADULT', emoji: 'üéì', minScore: 0, maxScore: 100, scale: 1.0, next: 100 },
            3: { name: 'ADULT', emoji: 'üéì', minScore: 0, maxScore: 100, scale: 1.0, next: 100 },
            4: { name: 'ADULT', emoji: 'üéì', minScore: 0, maxScore: 100, scale: 1.0, next: 100 }
        };

        // ============================================
        // BLENDER-STYLE VRM ANIMATION SYSTEM
        // Professional 3D animation with humanoid bones
        // ============================================

        let currentVRM = null;
        let animationMixer = null;
        let currentAction = null;
        let clock = new THREE.Clock();

        // VRM Humanoid Bone Names (Unity/VRM standard)
        const VRMBones = {
            hips: 'hips',
            spine: 'spine',
            chest: 'chest',
            neck: 'neck',
            head: 'head',
            leftShoulder: 'leftShoulder',
            leftUpperArm: 'leftUpperArm',
            leftLowerArm: 'leftLowerArm',
            leftHand: 'leftHand',
            rightShoulder: 'rightShoulder',
            rightUpperArm: 'rightUpperArm',
            rightLowerArm: 'rightLowerArm',
            rightHand: 'rightHand',
            leftUpperLeg: 'leftUpperLeg',
            leftLowerLeg: 'leftLowerLeg',
            leftFoot: 'leftFoot',
            rightUpperLeg: 'rightUpperLeg',
            rightLowerLeg: 'rightLowerLeg',
            rightFoot: 'rightFoot'
        };

        // Animation keyframe data (Blender-style)
        const animationClips = {
            IDLE: {
                name: 'IDLE',
                emoji: 'üßç',
                duration: 4,
                loop: true,
                keyframes: {
                    hips: {
                        position: [
                            { t: 0, y: 0 },
                            { t: 2, y: 0.02 },
                            { t: 4, y: 0 }
                        ],
                        rotation: [
                            { t: 0, x: 0, y: 0, z: 0 },
                            { t: 4, x: 0, y: 0, z: 0 }
                        ]
                    },
                    spine: {
                        rotation: [
                            { t: 0, x: 0, y: 0, z: 0 },
                            { t: 2, x: 0.02, y: 0.05, z: 0 },
                            { t: 4, x: 0, y: 0, z: 0 }
                        ]
                    },
                    chest: {
                        rotation: [
                            { t: 0, x: 0, y: 0, z: 0 },
                            { t: 2, x: 0.03, y: -0.03, z: 0 },
                            { t: 4, x: 0, y: 0, z: 0 }
                        ]
                    },
                    leftUpperArm: {
                        rotation: [
                            { t: 0, x: 0, y: 0, z: 0.1 },
                            { t: 2, x: 0.05, y: 0, z: 0.12 },
                            { t: 4, x: 0, y: 0, z: 0.1 }
                        ]
                    },
                    rightUpperArm: {
                        rotation: [
                            { t: 0, x: 0, y: 0, z: -0.1 },
                            { t: 2, x: 0.05, y: 0, z: -0.12 },
                            { t: 4, x: 0, y: 0, z: -0.1 }
                        ]
                    }
                }
            },

            WAVE: {
                name: 'WAVE',
                emoji: 'üëã',
                duration: 2,
                loop: true,
                keyframes: {
                    hips: {
                        rotation: [
                            { t: 0, x: 0, y: 0.2, z: 0 },
                            { t: 1, x: 0, y: -0.1, z: 0 },
                            { t: 2, x: 0, y: 0.2, z: 0 }
                        ]
                    },
                    spine: {
                        rotation: [
                            { t: 0, x: 0, y: 0.1, z: 0 },
                            { t: 1, x: 0, y: -0.05, z: 0 },
                            { t: 2, x: 0, y: 0.1, z: 0 }
                        ]
                    },
                    rightShoulder: {
                        rotation: [
                            { t: 0, x: 0, y: 0, z: -0.5 },
                            { t: 0.5, x: 0, y: 0, z: -2.0 },
                            { t: 1.0, x: 0, y: 0, z: -2.2 },
                            { t: 1.5, x: 0, y: 0, z: -2.0 },
                            { t: 2, x: 0, y: 0, z: -0.5 }
                        ]
                    },
                    rightUpperArm: {
                        rotation: [
                            { t: 0, x: 0, y: 0, z: 0 },
                            { t: 0.5, x: 0, y: 0, z: -0.5 },
                            { t: 1.0, x: 0, y: 0, z: -0.3 },
                            { t: 1.5, x: 0, y: 0, z: -0.5 },
                            { t: 2, x: 0, y: 0, z: 0 }
                        ]
                    },
                    rightLowerArm: {
                        rotation: [
                            { t: 0, x: 0, y: 0, z: 0 },
                            { t: 0.25, x: 0, y: 0, z: -0.5 },
                            { t: 0.5, x: 0, y: 0, z: -0.3 },
                            { t: 0.75, x: 0, y: 0, z: -0.5 },
                            { t: 1.0, x: 0, y: 0, z: -0.3 },
                            { t: 1.25, x: 0, y: 0, z: -0.5 },
                            { t: 1.5, x: 0, y: 0, z: -0.3 },
                            { t: 1.75, x: 0, y: 0, z: -0.5 },
                            { t: 2, x: 0, y: 0, z: 0 }
                        ]
                    }
                }
            },

            WALK: {
                name: 'WALK',
                emoji: 'üö∂',
                duration: 1.2,
                loop: true,
                rootMotion: true,
                keyframes: {
                    hips: {
                        position: [
                            { t: 0, y: 0 },
                            { t: 0.3, y: 0.05 },
                            { t: 0.6, y: 0 },
                            { t: 0.9, y: 0.05 },
                            { t: 1.2, y: 0 }
                        ],
                        rotation: [
                            { t: 0, x: 0, y: 0, z: 0 },
                            { t: 0.3, x: 0.02, y: 0.1, z: 0.02 },
                            { t: 0.6, x: 0, y: 0, z: 0 },
                            { t: 0.9, x: 0.02, y: -0.1, z: -0.02 },
                            { t: 1.2, x: 0, y: 0, z: 0 }
                        ]
                    },
                    leftUpperLeg: {
                        rotation: [
                            { t: 0, x: -0.4, y: 0, z: 0 },
                            { t: 0.3, x: 0.3, y: 0, z: 0 },
                            { t: 0.6, x: 0.4, y: 0, z: 0 },
                            { t: 0.9, x: -0.1, y: 0, z: 0 },
                            { t: 1.2, x: -0.4, y: 0, z: 0 }
                        ]
                    },
                    leftLowerLeg: {
                        rotation: [
                            { t: 0, x: 0.1, y: 0, z: 0 },
                            { t: 0.3, x: 0.1, y: 0, z: 0 },
                            { t: 0.6, x: 1.2, y: 0, z: 0 },
                            { t: 0.9, x: 0.5, y: 0, z: 0 },
                            { t: 1.2, x: 0.1, y: 0, z: 0 }
                        ]
                    },
                    rightUpperLeg: {
                        rotation: [
                            { t: 0, x: 0.4, y: 0, z: 0 },
                            { t: 0.3, x: -0.1, y: 0, z: 0 },
                            { t: 0.6, x: -0.4, y: 0, z: 0 },
                            { t: 0.9, x: 0.3, y: 0, z: 0 },
                            { t: 1.2, x: 0.4, y: 0, z: 0 }
                        ]
                    },
                    rightLowerLeg: {
                        rotation: [
                            { t: 0, x: 1.2, y: 0, z: 0 },
                            { t: 0.3, x: 0.5, y: 0, z: 0 },
                            { t: 0.6, x: 0.1, y: 0, z: 0 },
                            { t: 0.9, x: 0.1, y: 0, z: 0 },
                            { t: 1.2, x: 1.2, y: 0, z: 0 }
                        ]
                    },
                    leftUpperArm: {
                        rotation: [
                            { t: 0, x: 0, y: 0, z: 0.1 },
                            { t: 0.6, x: 0, y: 0, z: -0.1 },
                            { t: 1.2, x: 0, y: 0, z: 0.1 }
                        ]
                    },
                    rightUpperArm: {
                        rotation: [
                            { t: 0, x: 0, y: 0, z: -0.1 },
                            { t: 0.6, x: 0, y: 0, z: 0.1 },
                            { t: 1.2, x: 0, y: 0, z: -0.1 }
                        ]
                    }
                }
            },

            DANCE: {
                name: 'DANCE',
                emoji: 'üíÉ',
                duration: 3.2,
                loop: true,
                keyframes: {
                    hips: {
                        position: [
                            { t: 0, y: 0 },
                            { t: 0.4, y: 0.1 },
                            { t: 0.8, y: 0 },
                            { t: 1.2, y: 0.15 },
                            { t: 1.6, y: 0 },
                            { t: 2.0, y: 0.1 },
                            { t: 2.4, y: 0 },
                            { t: 2.8, y: 0.2 },
                            { t: 3.2, y: 0 }
                        ],
                        rotation: [
                            { t: 0, x: 0, y: 0, z: 0 },
                            { t: 0.8, x: 0, y: 0.5, z: 0.1 },
                            { t: 1.6, x: 0, y: 0, z: -0.1 },
                            { t: 2.4, x: 0, y: -0.5, z: 0.1 },
                            { t: 3.2, x: 0, y: 0, z: 0 }
                        ]
                    },
                    spine: {
                        rotation: [
                            { t: 0, x: 0, y: 0, z: 0 },
                            { t: 0.8, x: 0.1, y: 0.2, z: 0.1 },
                            { t: 1.6, x: -0.05, y: 0, z: -0.05 },
                            { t: 2.4, x: 0.1, y: -0.2, z: 0.1 },
                            { t: 3.2, x: 0, y: 0, z: 0 }
                        ]
                    },
                    leftUpperArm: {
                        rotation: [
                            { t: 0, x: 0, y: 0, z: 0.5 },
                            { t: 0.8, x: -0.5, y: 0, z: 1.5 },
                            { t: 1.6, x: 0, y: 0, z: 0.5 },
                            { t: 2.4, x: -0.3, y: 0, z: 1.2 },
                            { t: 3.2, x: 0, y: 0, z: 0.5 }
                        ]
                    },
                    rightUpperArm: {
                        rotation: [
                            { t: 0, x: 0, y: 0, z: -0.5 },
                            { t: 0.8, x: -0.3, y: 0, z: -1.2 },
                            { t: 1.6, x: 0, y: 0, z: -0.5 },
                            { t: 2.4, x: -0.5, y: 0, z: -1.5 },
                            { t: 3.2, x: 0, y: 0, z: -0.5 }
                        ]
                    },
                    leftUpperLeg: {
                        rotation: [
                            { t: 0, x: 0, y: 0, z: 0 },
                            { t: 0.8, x: -0.3, y: 0, z: 0 },
                            { t: 1.6, x: 0.2, y: 0, z: 0 },
                            { t: 2.4, x: -0.4, y: 0, z: 0 },
                            { t: 3.2, x: 0, y: 0, z: 0 }
                        ]
                    },
                    rightUpperLeg: {
                        rotation: [
                            { t: 0, x: 0, y: 0, z: 0 },
                            { t: 0.8, x: 0.2, y: 0, z: 0 },
                            { t: 1.6, x: -0.3, y: 0, z: 0 },
                            { t: 2.4, x: 0.3, y: 0, z: 0 },
                            { t: 3.2, x: 0, y: 0, z: 0 }
                        ]
                    }
                }
            },

            JUMP: {
                name: 'JUMP',
                emoji: '‚¨ÜÔ∏è',
                duration: 1.5,
                loop: true,
                keyframes: {
                    hips: {
                        position: [
                            { t: 0, y: 0 },
                            { t: 0.3, y: 0.4 },
                            { t: 0.5, y: 0.6 },
                            { t: 0.75, y: 0.6 },
                            { t: 1.0, y: 0.3 },
                            { t: 1.5, y: 0 }
                        ],
                        rotation: [
                            { t: 0, x: 0, y: 0, z: 0 },
                            { t: 0.3, x: -0.1, y: 0, z: 0 },
                            { t: 0.5, x: -0.2, y: 3.14, z: 0 },
                            { t: 0.75, x: -0.2, y: 6.28, z: 0 },
                            { t: 1.0, x: -0.1, y: 6.28, z: 0 },
                            { t: 1.5, x: 0, y: 6.28, z: 0 }
                        ]
                    },
                    leftUpperArm: {
                        rotation: [
                            { t: 0, x: 0, y: 0, z: 0 },
                            { t: 0.3, x: 0, y: 0, z: 2.5 },
                            { t: 0.5, x: 0, y: 0, z: 2.8 },
                            { t: 1.0, x: 0, y: 0, z: 2.5 },
                            { t: 1.5, x: 0, y: 0, z: 0 }
                        ]
                    },
                    rightUpperArm: {
                        rotation: [
                            { t: 0, x: 0, y: 0, z: 0 },
                            { t: 0.3, x: 0, y: 0, z: -2.5 },
                            { t: 0.5, x: 0, y: 0, z: -2.8 },
                            { t: 1.0, x: 0, y: 0, z: -2.5 },
                            { t: 1.5, x: 0, y: 0, z: 0 }
                        ]
                    },
                    leftUpperLeg: {
                        rotation: [
                            { t: 0, x: 0, y: 0, z: 0 },
                            { t: 0.3, x: -0.8, y: 0, z: 0 },
                            { t: 0.5, x: -1.0, y: 0, z: 0 },
                            { t: 1.0, x: -0.5, y: 0, z: 0 },
                            { t: 1.5, x: 0, y: 0, z: 0 }
                        ]
                    },
                    rightUpperLeg: {
                        rotation: [
                            { t: 0, x: 0, y: 0, z: 0 },
                            { t: 0.3, x: -0.8, y: 0, z: 0 },
                            { t: 0.5, x: -1.0, y: 0, z: 0 },
                            { t: 1.0, x: -0.5, y: 0, z: 0 },
                            { t: 1.5, x: 0, y: 0, z: 0 }
                        ]
                    }
                }
            }
        };

        // Animation state

        // ============================================
        // BLENDER-STYLE ANIMATION FUNCTIONS
        // Quaternion interpolation, keyframe evaluation
        // ============================================

        // Linear interpolation between two values
        function lerp(a, b, t) {
            return a + (b - a) * t;
        }

        // Cubic ease interpolation (smooth start/end)
        function easeInOutCubic(t) {
            return t < 0.5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 3) / 2;
        }

        // Find keyframe indices for current time
        function findKeyframes(keyframes, currentTime) {
            for (let i = 0; i < keyframes.length - 1; i++) {
                if (currentTime >= keyframes[i].t && currentTime <= keyframes[i + 1].t) {
                    return { prev: i, next: i + 1 };
                }
            }
            return { prev: keyframes.length - 1, next: keyframes.length - 1 };
        }

        // Evaluate keyframe track at given time
        function evaluateKeyframeTrack(keyframes, currentTime, duration, loop) {
            if (!keyframes || keyframes.length === 0) return null;

            // Handle looping
            let t = currentTime;
            if (loop) {
                t = t % duration;
            } else {
                t = Math.min(t, duration);
            }

            const { prev, next } = findKeyframes(keyframes, t);

            if (prev === next) {
                return keyframes[prev];
            }

            const prevFrame = keyframes[prev];
            const nextFrame = keyframes[next];
            const localT = (t - prevFrame.t) / (nextFrame.t - prevFrame.t);
            const easedT = easeInOutCubic(localT);

            // Interpolate all properties
            const result = { t: t };
            for (const key of Object.keys(prevFrame)) {
                if (key === 't') continue;
                if (typeof prevFrame[key] === 'number') {
                    result[key] = lerp(prevFrame[key], nextFrame[key], easedT);
                }
            }

            return result;
        }

        // Apply rotation to bone using quaternion
        function applyBoneRotation(bone, rotationData) {
            if (!bone || !rotationData) return;

            const euler = new THREE.Euler(
                rotationData.x || 0,
                rotationData.y || 0,
                rotationData.z || 0,
                'XYZ'
            );

            const quaternion = new THREE.Quaternion();
            quaternion.setFromEuler(euler);

            // Blend with current rotation for smoothness
            bone.quaternion.slerp(quaternion, 0.3);
        }

        // Get VRM bone by name
        function getVRMBone(vrm, boneName) {
            if (!vrm || !vrm.humanoid) return null;

            const humanoid = vrm.humanoid;

            // Try to get bone directly
            if (humanoid.getBoneNode) {
                const boneEnum = THREE.VRMSchema?.HumanoidBoneName?.[boneName];
                if (boneEnum) {
                    return humanoid.getBoneNode(boneEnum);
                }
            }

            // Fallback: search through humanoid bones
            const boneMap = {
                'hips': 'hips',
                'spine': 'spine',
                'chest': 'upperChest',
                'neck': 'neck',
                'head': 'head',
                'leftShoulder': 'leftShoulder',
                'leftUpperArm': 'leftUpperArm',
                'leftLowerArm': 'leftLowerArm',
                'leftHand': 'leftHand',
                'rightShoulder': 'rightShoulder',
                'rightUpperArm': 'rightUpperArm',
                'rightLowerArm': 'rightLowerArm',
                'rightHand': 'rightHand',
                'leftUpperLeg': 'leftUpperLeg',
                'leftLowerLeg': 'leftLowerLeg',
                'leftFoot': 'leftFoot',
                'rightUpperLeg': 'rightUpperLeg',
                'rightLowerLeg': 'rightLowerLeg',
                'rightFoot': 'rightFoot'
            };

            const vrmBoneName = boneMap[boneName];
            if (!vrmBoneName) return null;

            // Try different VRM schema versions
            try {
                if (THREE.VRMSchema?.HumanoidBoneName?.[vrmBoneName]) {
                    return humanoid.getBoneNode(THREE.VRMSchema.HumanoidBoneName[vrmBoneName]);
                }
            } catch (e) {
                // Fallback: try direct name
            }

            return null;
        }

        // Apply animation clip to VRM
        function applyAnimationClip(vrm, clipName, elapsedTime) {
            if (!vrm || !vrm.humanoid) return;

            const clip = animationClips[clipName];
            if (!clip) return;

            const keyframes = clip.keyframes;

            // Apply each bone's animation
            for (const [boneName, boneData] of Object.entries(keyframes)) {
                const bone = getVRMBone(vrm, boneName);
                if (!bone) continue;

                // Evaluate position if present
                if (boneData.position) {
                    const pos = evaluateKeyframeTrack(boneData.position, elapsedTime, clip.duration, clip.loop);
                    if (pos) {
                        if (pos.x !== undefined) bone.position.x = pos.x;
                        if (pos.y !== undefined) bone.position.y = pos.y;
                        if (pos.z !== undefined) bone.position.z = pos.z;
                    }
                }

                // Evaluate rotation if present
                if (boneData.rotation) {
                    const rot = evaluateKeyframeTrack(boneData.rotation, elapsedTime, clip.duration, clip.loop);
                    if (rot) {
                        applyBoneRotation(bone, rot);
                    }
                }
            }

            // Update VRM
            if (vrm.update) {
                vrm.update(0.016); // ~60fps delta
            }
        }

        // Root motion for walking
        function applyRootMotion(elapsedTime, clip) {
            if (!clip.rootMotion || !character) return;

            const walkRadius = 0.6;
            const walkSpeed = 0.5;
            const angle = elapsedTime * walkSpeed;

            // Figure-8 pattern
            const x = walkRadius * Math.sin(angle * 2);
            const z = walkRadius * Math.sin(angle) * 0.5;

            character.position.x = x;
            character.position.z = z;

            // Face direction of movement
            const nextX = walkRadius * Math.sin((angle + 0.1) * 2);
            const nextZ = walkRadius * Math.sin(angle + 0.1) * 0.5;
            character.rotation.y = Math.atan2(nextX - x, nextZ - z);
        }

        // Main animation update function
        function updateAnimation() {
            if (!isAnimating || !currentAnimationType) return;

            const clip = animationClips[currentAnimationType.toUpperCase()];
            if (!clip) return;

            const elapsed = (Date.now() - animationStartTime) / 1000;

            // Apply VRM bone animations
            if (window.currentVRM) {
                applyAnimationClip(window.currentVRM, currentAnimationType.toUpperCase(), elapsed);
            }

            // Apply root motion for walking
            if (clip.rootMotion) {
                applyRootMotion(elapsed, clip);
            }

            // Continue animation loop
            if (clip.loop || elapsed < clip.duration) {
                requestAnimationFrame(updateAnimation);
            } else {
                // Animation finished, hold last pose
                isAnimating = false;
            }
        }

        const poses = Object.keys(animationClips).map(key => ({
            name: animationClips[key].name,
            emoji: animationClips[key].emoji,
            type: key.toLowerCase()
        }));

        let currentAnimationType = null;
        let animationStartTime = 0;
        let isAnimating = false;
        let walkPathTime = 0;
        let walkCenter = new THREE.Vector3(0, 0, 0);

        // Wealth Milestones for Environment
        const WEALTH_MILESTONES = [
            { threshold: 10, name: 'BASIC LIGHT', emoji: 'üí°', type: 'basicLight' },
            { threshold: 20, name: 'SMALL PLANT', emoji: 'üå±', type: 'smallPlant' },
            { threshold: 30, name: 'RUG', emoji: 'üß∂', type: 'rug' },
            { threshold: 40, name: 'POSTER', emoji: 'üñºÔ∏è', type: 'poster' },
            { threshold: 50, name: 'SMALL TABLE', emoji: 'üõèÔ∏è', type: 'smallTable' },
            { threshold: 60, name: 'BETTER LAMP', emoji: 'üõãÔ∏è', type: 'betterLamp' },
            { threshold: 70, name: 'BOOKSHELF', emoji: 'üìö', type: 'bookshelf' },
            { threshold: 80, name: 'SMALL TV', emoji: 'üì∫', type: 'smallTV' },
            { threshold: 90, name: 'COMFY CHAIR', emoji: 'ü™ë', type: 'comfyChair' },
            { threshold: 100, name: 'COFFEE TABLE', emoji: '‚òï', type: 'coffeeTable' }
        ];

        // Environment Tiers (P1-027)
        const ENVIRONMENT_TIERS = [
            {
                name: 'SMALL ROOM',
                emoji: 'üè†',
                minWealth: 0,
                bgColor: 0x1a1a2e,
                floorColor: 0x0f0f1a,
                lighting: 0.6,
                fog: true,
                fogColor: 0x1a1a2e
            },
            {
                name: 'COZY APARTMENT',
                emoji: 'üè¢',
                minWealth: 25,
                bgColor: 0x2d1b4e,
                floorColor: 0x1a1a2e,
                lighting: 0.7,
                fog: true,
                fogColor: 0x2d1b4e
            },
            {
                name: 'NICE HOUSE',
                emoji: 'üè°',
                minWealth: 50,
                bgColor: 0x1e3a5f,
                floorColor: 0x2d1b4e,
                lighting: 0.8,
                fog: false,
                fogColor: 0x1e3a5f
            },
            {
                name: 'LUXURY MANSION',
                emoji: 'üè∞',
                minWealth: 75,
                bgColor: 0x2a2a4e,
                floorColor: 0x1e3a5f,
                lighting: 0.9,
                fog: false,
                fogColor: 0x2a2a4e
            },
            {
                name: 'ROYAL PALACE',
                emoji: 'üëë',
                minWealth: 90,
                bgColor: 0x3d1b6e,
                floorColor: 0x2a2a4e,
                lighting: 1.0,
                fog: false,
                fogColor: 0x3d1b6e
            }
        ];

        let currentEnvironmentTier = 0;

        function initCharacter() {
            const container = document.getElementById('character-canvas');
            const width = container.clientWidth;
            const height = container.clientHeight;

            // Scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1a1a2e);

            // Camera
            camera = new THREE.PerspectiveCamera(45, width / height, 0.1, 1000);
            camera.position.set(0, 1.2, 2.5);

            // Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(width, height);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.shadowMap.enabled = true;
            container.appendChild(renderer.domElement);

            // Lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(2, 5, 3);
            directionalLight.castShadow = true;
            scene.add(directionalLight);

            const rimLight = new THREE.DirectionalLight(0x00d4ff, 0.5);
            rimLight.position.set(-2, 3, -2);
            scene.add(rimLight);

            // Ground
            const groundGeometry = new THREE.CircleGeometry(2, 32);
            const groundMaterial = new THREE.MeshBasicMaterial({
                color: 0x0f0f1a,
                transparent: true,
                opacity: 0.8
            });
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            ground.position.y = -0.5;
            scene.add(ground);

            // Controls
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.minDistance = 1.5;
            controls.maxDistance = 4;
            controls.enablePan = false;

            // Load VRM with timeout fallback
            loadVRM();

            // Start pose rotation
            startPoseRotation();

            // Initialize environment
            initEnvironment();

            // Animation loop
            animate();

            // Hide loading after VRM loads (handled in loadVRM)
            // OR timeout after 8 seconds to show fallback
            setTimeout(() => {
                if (!character) {
                    console.warn('‚è±Ô∏è VRM loading timeout, creating fallback...');
                    createFallbackCharacter();
                    document.getElementById('loadingOverlay').classList.add('hidden');
                }
            }, 8000);
        }

        function loadVRM() {
            // Show fallback immediately while VRM loads in background
            console.log('üé≠ Loading VRM #11318 in background...');

            // Create fallback first so user sees something immediately
            createFallbackCharacter();

            // Try to load VRM in background
            if (typeof THREE.VRM === 'undefined') {
                console.warn('‚ö†Ô∏è THREE.VRM not loaded, keeping fallback');
                document.getElementById('loadingOverlay').classList.add('hidden');
                return;
            }

            const loader = new THREE.GLTFLoader();

            // Use a reliable CORS proxy
            const vrmUrl = 'https://api.allorigins.win/raw?url=' + encodeURIComponent('https://files.meebits.app/vrm/11318.vrm');

            console.log('üîÑ Loading VRM:', vrmUrl.substring(0, 50) + '...');

            loader.load(
                vrmUrl,
                function(gltf) {
                    console.log('‚úÖ GLTF loaded, converting to VRM...');

                    THREE.VRM.from(gltf).then((vrm) => {
                        console.log('‚úÖ VRM #11318 loaded!');

                        // Remove fallback
                        if (character) scene.remove(character);

                        character = vrm.scene;
                        character.scale.set(0.4, 0.4, 0.4);
                        character.position.set(0, -0.5, 0);

                        character.traverse((child) => {
                            if (child.isMesh) {
                                child.castShadow = true;
                                child.receiveShadow = true;

                                // Remove blue/cyan artifacts (floating planes)
                                const color = child.material?.color;
                                if (color) {
                                    const hex = color.getHex();
                                    // Check for bright blue/cyan colors (artifacts)
                                    if (hex === 0x00d4ff || hex === 0x4ecdc4 || hex === 0x00ffff) {
                                        console.log('üßπ Removing blue artifact:', child.name);
                                        child.visible = false;
                                    }
                                }
                            }
                        });

                        scene.add(character);
                        window.currentVRM = vrm;

                        showNotification('‚úÖ VRM #11318 LOADED!');
                    }).catch((error) => {
                        console.warn('‚ö†Ô∏è VRM conversion failed, keeping fallback:', error);
                    });
                },
                function(xhr) {
                    if (xhr.total > 0) {
                        const percent = Math.round((xhr.loaded / xhr.total) * 100);
                        console.log('VRM loading: ' + percent + '%');
                    }
                },
                function(error) {
                    console.warn('‚ö†Ô∏è VRM load failed, keeping fallback:', error.message);
                }
            );

            // Hide loading overlay immediately (fallback is showing)
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        // Fallback GLTF loader without VRM conversion
        function loadVRMWithGLTF() {
            const loader = new THREE.GLTFLoader();
            const vrmUrl = 'https://api.allorigins.win/raw?url=' + encodeURIComponent('https://files.meebits.app/vrm/11318.vrm');

            loader.load(
                vrmUrl,
                function(gltf) {
                    console.log('‚úÖ GLTF loaded (no VRM conversion)');

                    if (character) scene.remove(character);

                    character = gltf.scene;
                    character.scale.set(0.4, 0.4, 0.4);
                    character.position.set(0, -0.5, 0);

                    character.traverse((child) => {
                        if (child.isMesh) {
                            child.castShadow = true;
                            child.receiveShadow = true;
                        }
                    });

                    scene.add(character);
                    document.getElementById('loadingOverlay').classList.add('hidden');
                    showNotification('‚úÖ MODEL LOADED!');
                },
                undefined,
                function(error) {
                    console.warn('‚ö†Ô∏è GLTF load failed:', error);
                    createFallbackCharacter();
                }
            );
        }

        function createFallbackCharacter() {
            // Remove any existing character first
            if (character) {
                scene.remove(character);
            }

            // Create pixel-style character as fallback
            const group = new THREE.Group();

            // Body
            const bodyGeo = new THREE.BoxGeometry(0.3, 0.5, 0.2);
            const bodyMat = new THREE.MeshPhongMaterial({ color: 0x00d4ff });
            const body = new THREE.Mesh(bodyGeo, bodyMat);
            body.position.y = 0;
            body.castShadow = true;
            group.add(body);

            // Head
            const headGeo = new THREE.BoxGeometry(0.25, 0.25, 0.25);
            const headMat = new THREE.MeshPhongMaterial({ color: 0xffe66d });
            const head = new THREE.Mesh(headGeo, headMat);
            head.position.y = 0.4;
            head.castShadow = true;
            group.add(head);

            // Arms
            const armGeo = new THREE.BoxGeometry(0.08, 0.3, 0.08);
            const armMat = new THREE.MeshPhongMaterial({ color: 0x00d4ff });

            const leftArm = new THREE.Mesh(armGeo, armMat);
            leftArm.position.set(-0.22, 0.1, 0);
            group.add(leftArm);

            const rightArm = new THREE.Mesh(armGeo, armMat);
            rightArm.position.set(0.22, 0.1, 0);
            group.add(rightArm);

            // Legs
            const legGeo = new THREE.BoxGeometry(0.1, 0.4, 0.1);
            const legMat = new THREE.MeshPhongMaterial({ color: 0x9d4edd });

            const leftLeg = new THREE.Mesh(legGeo, legMat);
            leftLeg.position.set(-0.1, -0.45, 0);
            group.add(leftLeg);

            const rightLeg = new THREE.Mesh(legGeo, legMat);
            rightLeg.position.set(0.1, -0.45, 0);
            group.add(rightLeg);

            character = group;
            // FIXED SCALE: Fallback character also uses fixed scale (1.0)
            character.scale.set(0.8, 0.8, 0.8);
            character.position.set(0, 0, 0);
            scene.add(character);

            applyPose(0);

            // Hide loading overlay
            document.getElementById('loadingOverlay').classList.add('hidden');

            showNotification('‚ö†Ô∏è USING FALLBACK CHARACTER');
        }

        function applyPose(poseIndex) {
            if (!character) return;

            const pose = poses[poseIndex];
            currentAnimationType = pose.type.toUpperCase();
            animationStartTime = Date.now();
            isAnimating = true;

            // Update movement indicator
            const indicator = document.getElementById('movementIndicator');
            if (indicator) {
                indicator.innerHTML = `<span>${pose.emoji}</span><span>${pose.name}</span>`;
            }

            // Reset character position for non-walking poses
            const clip = animationClips[currentAnimationType];
            if (clip && !clip.rootMotion) {
                character.position.x = 0;
                character.position.z = 0;
                if (character.rotation.y > Math.PI * 2) {
                    character.rotation.y = character.rotation.y % (Math.PI * 2);
                }
            }

            // Start animation
            updateAnimation();
        }

        // Start continuous animation for dynamic poses
        function startPoseAnimation(pose) {
            // Animation is now handled by updateAnimation
        }

        // Animation functions (placeholders for compatibility)
        function animateWave() {}
        function animateWalk() {}
        function animateDance() {}
        function animateJump() {}
        function animateSpin() {}
        function animateCelebrate() {}
        function animateStretch() {}
        function animateLookAround() {}

        function startPoseRotation() {
            // Clear any existing interval
            if (poseInterval) {
                clearInterval(poseInterval);
            }

            // Change pose every 10 seconds
            poseInterval = setInterval(() => {
                // Reset position before changing pose
                if (character) {
                    character.position.x = 0;
                    character.position.z = 0;
                    character.scale.set(0.4, 0.4, 0.4);
                }

                currentPose = (currentPose + 1) % poses.length;
                applyPose(currentPose);
            }, 10000);
        }

        function randomPose() {
            // Reset position before changing pose
            if (character) {
                character.position.x = 0;
                character.position.z = 0;
                character.scale.set(0.4, 0.4, 0.4);
            }

            currentPose = Math.floor(Math.random() * poses.length);
            applyPose(currentPose);
        }

        // P1-018: Daily Quiz
        const QUIZ_QUESTIONS = [
            {
                q: "üß† What is the 50/30/20 rule in budgeting?",
                options: ["50% needs, 30% wants, 20% savings", "50% savings, 30% needs, 20% wants", "50% wants, 30% savings, 20% needs"],
                correct: 0
            },
            {
                q: "üí™ How many minutes of exercise per week is recommended?",
                options: ["60 minutes", "150 minutes", "300 minutes"],
                correct: 1
            },
            {
                q: "üí∞ What is compound interest?",
                options: ["Interest on principal only", "Interest on principal + accumulated interest", "A type of bank account"],
                correct: 1
            }
        ];

        let quizAnswered = localStorage.getItem('mc_quiz_' + new Date().toDateString()) || false;

        function loadDailyQuiz() {
            if (quizAnswered) {
                document.getElementById('quizStatus').textContent = '‚úÖ COMPLETED';
                document.getElementById('quizQuestion').style.display = 'none';
                document.getElementById('quizResult').style.display = 'block';
                document.getElementById('quizResult').innerHTML = '<p style="color: var(--pixel-green);">üéâ Already answered today!</p>';
            }
        }

        function answerQuiz(answer) {
            if (quizAnswered) return;

            const correct = answer === 'a'; // First option is correct for now
            quizAnswered = true;
            localStorage.setItem('mc_quiz_' + new Date().toDateString(), 'true');

            document.getElementById('quizStatus').textContent = '‚úÖ COMPLETED';
            document.getElementById('quizQuestion').style.display = 'none';
            document.getElementById('quizResult').style.display = 'block';

            if (correct) {
                document.getElementById('quizResult').innerHTML = '<p style="color: var(--pixel-green);">üéâ CORRECT! +10 COINS</p>';
                showNotification('üéâ QUIZ CORRECT! +10 COINS');
            } else {
                document.getElementById('quizResult').innerHTML = '<p style="color: var(--pixel-pink);">‚ùå WRONG! Try again tomorrow.</p>';
                showNotification('‚ùå WRONG ANSWER');
            }
        }

        // P1-010: Achievement Badges System
        const ACHIEVEMENTS = [
            { id: 'first_login', name: 'First Steps', desc: 'Log in for the first time', emoji: 'üë∂', condition: () => true },
            { id: 'week_streak', name: 'Week Warrior', desc: '7-day streak', emoji: 'üî•', condition: () => (growthState.streak || 0) >= 7 },
            { id: 'month_streak', name: 'Month Master', desc: '30-day streak', emoji: 'üíé', condition: () => (growthState.streak || 0) >= 30 },
            { id: 'wealth_50', name: 'Money Maker', desc: 'Reach 50 wealth', emoji: 'üí∞', condition: () => growthState.wealthScore >= 50 },
            { id: 'wealth_100', name: 'Wealth King', desc: 'Reach 100 wealth', emoji: 'üëë', condition: () => growthState.wealthScore >= 100 },
            { id: 'health_50', name: 'Health Nut', desc: 'Reach 50 health', emoji: '‚ù§Ô∏è', condition: () => growthState.healthScore >= 50 },
            { id: 'health_100', name: 'Fitness God', desc: 'Reach 100 health', emoji: 'üí™', condition: () => growthState.healthScore >= 100 },
            { id: 'max_level', name: 'Maxed Out', desc: 'Reach max level', emoji: 'üèÜ', condition: () => growthState.level >= 4 },
            { id: 'first_confession', name: 'Confessor', desc: 'Post first confession', emoji: 'üì¢', condition: () => confessions.length > 0 },
            { id: 'quiz_master', name: 'Quiz Master', desc: 'Answer 5 quizzes correctly', emoji: 'üß†', condition: () => false } // Would track quiz history
        ];

        let unlockedAchievements = JSON.parse(localStorage.getItem('mc_achievements') || '[]');

        function checkAchievements() {
            ACHIEVEMENTS.forEach(ach => {
                if (!unlockedAchievements.includes(ach.id) && ach.condition()) {
                    unlockAchievement(ach);
                }
            });
        }

        function unlockAchievement(ach) {
            unlockedAchievements.push(ach.id);
            localStorage.setItem('mc_achievements', JSON.stringify(unlockedAchievements));
            SoundFX.play('achievement');
            showNotification(`üèÜ ACHIEVEMENT: ${ach.emoji} ${ach.name}!`);
            renderAchievements();
        }

        function renderAchievements() {
            const container = document.getElementById('achievementsList');
            const countEl = document.getElementById('achievementCount');
            if (!container) return;

            container.innerHTML = ACHIEVEMENTS.map(ach => {
                const unlocked = unlockedAchievements.includes(ach.id);
                return `
                    <div class="pixel-card" style="flex: 1; min-width: 150px; padding: 0.75rem; opacity: ${unlocked ? 1 : 0.5};">
                        <div style="font-size: 2rem; text-align: center; margin-bottom: 0.5rem;">${ach.emoji}</div>
                        <div style="font-family: var(--font-pixel); font-size: 8px; text-align: center;">${ach.name}</div>
                        <div style="font-size: 12px; color: #888; text-align: center; margin-top: 0.25rem;">${unlocked ? '‚úÖ' : 'üîí'}</div>
                    </div>
                `;
            }).join('');

            if (countEl) countEl.textContent = `${unlockedAchievements.length}/${ACHIEVEMENTS.length}`;
        }

        // Export Report (P1-032 alternative)

        // FULLSCREEN MODE
        let isFullscreen = false;

        // P1-026: Browser Notifications
        function requestNotificationPermission() {
            if ('Notification' in window) {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        showNotification('üîî NOTIFICATIONS ENABLED!');
                    }
                });
            }
        }

        function sendStreakReminder() {
            if (Notification.permission === 'granted') {
                new Notification('üî• MC Project Streak!', {
                    body: 'Don\'t break your streak! Log your progress today.',
                    icon: 'üéÆ'
                });
            }
        }

        // Check streak at 8 PM
        setInterval(() => {
            const hour = new Date().getHours();
            if (hour === 20) {
                sendStreakReminder();
            }
        }, 3600000); // Check every hour

        // Export Report (P1-032 alternative)
        function exportReport() {
            const report = `MC PROJECT WEEKLY REPORT
Date: ${new Date().toLocaleDateString()}

CHARACTER STATS:
- Level: ${growthState.level}
- Health: ${growthState.healthScore}/100
- Wealth: ${growthState.wealthScore}/100
- Combined: ${growthState.combinedScore}/100

ACHIEVEMENTS: ${unlockedAchievements.length}/${ACHIEVEMENTS.length}

Keep up the great work! üéÆ`;
            
            const blob = new Blob([report], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'mc-project-report.txt';
            a.click();
            URL.revokeObjectURL(url);
            showNotification('üìä REPORT DOWNLOADED!');
        }

        // P1-025: Social Sharing
        function shareToTwitter() {
            const text = `üéÆ My MC Project Character is LVL ${growthState.level}!\nüí∞ Wealth: ${growthState.wealthScore}/100\n‚ù§Ô∏è Health: ${growthState.healthScore}/100\nüî• ${growthState.combinedScore}/100 Combined Score!`;
            const url = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&hashtags=MCProject,GenZWealth,HealthStreak`;
            window.open(url, '_blank');
            showNotification('üì§ OPENED TWITTER SHARE!');
        }

        // P1-023: Sound Effects System
        const SoundFX = {
            enabled: localStorage.getItem('mc_sound') !== 'off',
            
            play(type) {
                if (!this.enabled) return;
                
                const audio = new Audio();
                audio.volume = 0.3;
                
                switch(type) {
                    case 'click':
                        // Simple beep using Web Audio API
                        this.playBeep(800, 0.1);
                        break;
                    case 'pose':
                        this.playBeep(600, 0.15);
                        break;
                    case 'achievement':
                        this.playBeep(1000, 0.3);
                        setTimeout(() => this.playBeep(1200, 0.3), 100);
                        break;
                    case 'levelup':
                        this.playBeep(800, 0.2);
                        setTimeout(() => this.playBeep(1000, 0.2), 100);
                        setTimeout(() => this.playBeep(1200, 0.3), 200);
                        break;
                }
            },
            
            playBeep(frequency, duration) {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                
                oscillator.frequency.value = frequency;
                oscillator.type = 'square';
                
                gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
                
                oscillator.start(audioCtx.currentTime);
                oscillator.stop(audioCtx.currentTime + duration);
            },
            
            toggle() {
                this.enabled = !this.enabled;
                localStorage.setItem('mc_sound', this.enabled ? 'on' : 'off');
                showNotification(this.enabled ? 'üîä SOUND ON' : 'üîá SOUND OFF');
            }
        };

        // Add sound to button clicks
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('pixel-btn')) {
                SoundFX.play('click');
            }
        });

        function toggleFullscreen() {
            isFullscreen = !isFullscreen;
            const canvas = document.getElementById('character-canvas');

            if (isFullscreen) {
                // Hide UI elements
                document.querySelector('.pixel-header').style.display = 'none';
                document.querySelector('.viewer-controls').style.display = 'none';
                document.querySelector('.growth-panel').style.display = 'none';
                document.querySelector('.environment-panel').style.display = 'none';
                document.querySelector('.character-overlay').style.display = 'none';
                document.querySelector('.movement-indicator').style.display = 'none';
                document.querySelector('.viewer-title').style.display = 'none';

                // Expand canvas
                canvas.style.position = 'fixed';
                canvas.style.top = '0';
                canvas.style.left = '0';
                canvas.style.width = '100vw';
                canvas.style.height = '100vh';
                canvas.style.zIndex = '9999';

                // Resize renderer
                renderer.setSize(window.innerWidth, window.innerHeight);
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();

                // Request browser fullscreen
                if (document.documentElement.requestFullscreen) {
                    document.documentElement.requestFullscreen();
                }

                showNotification('‚õ∂ FULLSCREEN MODE - Press ESC to exit');
            } else {
                // Show UI elements
                document.querySelector('.pixel-header').style.display = 'flex';
                document.querySelector('.viewer-controls').style.display = 'flex';
                document.querySelector('.growth-panel').style.display = 'block';
                document.querySelector('.environment-panel').style.display = 'block';
                document.querySelector('.character-overlay').style.display = 'flex';
                document.querySelector('.movement-indicator').style.display = 'flex';
                document.querySelector('.viewer-title').style.display = 'block';

                // Reset canvas
                canvas.style.position = 'relative';
                canvas.style.top = 'auto';
                canvas.style.left = 'auto';
                canvas.style.width = '100%';
                canvas.style.height = '400px';
                canvas.style.zIndex = 'auto';

                // Resize renderer
                const container = document.getElementById('character-canvas');
                renderer.setSize(container.clientWidth, 400);
                camera.aspect = container.clientWidth / 400;
                camera.updateProjectionMatrix();

                // Exit browser fullscreen
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }

        // ESC key to exit fullscreen
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && isFullscreen) {
                toggleFullscreen();
            }
        });

        // Handle browser fullscreen change
        document.addEventListener('fullscreenchange', () => {
            if (!document.fullscreenElement && isFullscreen) {
                isFullscreen = false;
                // Reset UI
                document.querySelector('.pixel-header').style.display = 'flex';
                document.querySelector('.viewer-controls').style.display = 'flex';
                document.querySelector('.growth-panel').style.display = 'block';
                document.querySelector('.environment-panel').style.display = 'block';
                document.querySelector('.character-overlay').style.display = 'flex';
                document.querySelector('.movement-indicator').style.display = 'flex';
                document.querySelector('.viewer-title').style.display = 'block';

                const canvas = document.getElementById('character-canvas');
                canvas.style.position = 'relative';
                canvas.style.top = 'auto';
                canvas.style.left = 'auto';
                canvas.style.width = '100%';
                canvas.style.height = '400px';
                canvas.style.zIndex = 'auto';

                const container = document.getElementById('character-canvas');
                renderer.setSize(container.clientWidth, 400);
                camera.aspect = container.clientWidth / 400;
                camera.updateProjectionMatrix();
            }
        });

        function animate() {
            requestAnimationFrame(animate);

            // Idle animation only when in IDLE pose
            if (character && currentAnimationType === 'static' && poses[currentPose].name === 'IDLE') {
                const elapsed = Date.now();
                character.position.y = Math.sin(elapsed * 0.002) * 0.02;
                character.rotation.y = Math.sin(elapsed * 0.001) * 0.05;
            }

            controls.update();
            renderer.render(scene, camera);
        }

        function rotateCharacter() {
            if (character) {
                character.rotation.y += Math.PI / 2;
            }
        }

        function toggleWireframe() {
            isWireframe = !isWireframe;
            if (character) {
                character.traverse((child) => {
                    if (child.isMesh && child.material) {
                        child.material.wireframe = isWireframe;
                    }
                });
            }
        }

        function resetView() {
            camera.position.set(0, 1.2, 2.5);
            camera.lookAt(0, 0, 0);

            // Reset character position
            if (character) {
                character.position.x = 0;
                character.position.z = 0;
                character.scale.set(0.4, 0.4, 0.4);
                character.rotation.set(0, 0, 0);
            }

            applyPose(currentPose);
        }

        // Environment System
        function initEnvironment() {
            // Clear any existing environment objects
            environmentObjects.forEach(obj => scene.remove(obj));
            environmentObjects = [];

            // Check and unlock items based on wealth
            checkAndUnlockItems(growthState.wealthScore);
        }

        function checkAndUnlockItems(wealthValue) {
            let newUnlocks = false;
            WEALTH_MILESTONES.forEach(milestone => {
                if (wealthValue >= milestone.threshold && !unlockedItems.has(milestone.type)) {
                    unlockedItems.add(milestone.type);
                    unlockItem(milestone);
                    newUnlocks = true;
                }
            });

            if (newUnlocks) {
                renderEnvironmentObjects();
            }

            updateEnvironmentUI();
        }

        function unlockItem(milestone) {
            // Show notification
            showNotification(`${milestone.emoji} UNLOCKED: ${milestone.name}!`);
        }

        function renderEnvironmentObjects() {
            // Clear existing environment objects
            environmentObjects.forEach(obj => scene.remove(obj));
            environmentObjects = [];

            const unlockedList = Array.from(unlockedItems);

            // Create 3D objects for each unlocked item
            unlockedList.forEach((itemType, index) => {
                const obj = createEnvironmentObject(itemType, index, unlockedList.length);
                if (obj) {
                    scene.add(obj);
                    environmentObjects.push(obj);
                }
            });
        }

        function createEnvironmentObject(type, index, total) {
            const group = new THREE.Group();

            // Position items in a semi-circle around the character
            const angle = (index / Math.max(total, 1)) * Math.PI - Math.PI / 2;
            const radius = 1.2;
            group.position.set(
                Math.sin(angle) * radius,
                -0.5,
                Math.cos(angle) * radius - 0.5
            );

            switch(type) {
                case 'basicLight':
                    // Simple lamp post
                    const lampPost = new THREE.Mesh(
                        new THREE.CylinderGeometry(0.02, 0.02, 0.6),
                        new THREE.MeshPhongMaterial({ color: 0x666666 })
                    );
                    lampPost.position.y = 0.3;
                    group.add(lampPost);

                    const lampShade = new THREE.Mesh(
                        new THREE.ConeGeometry(0.1, 0.15, 8),
                        new THREE.MeshPhongMaterial({ color: 0xffffaa, emissive: 0xffffaa, emissiveIntensity: 0.3 })
                    );
                    lampShade.position.y = 0.6;
                    group.add(lampShade);

                    // Add point light
                    const light = new THREE.PointLight(0xffffaa, 0.5, 2);
                    light.position.y = 0.5;
                    group.add(light);
                    break;

                case 'smallPlant':
                    // Pot
                    const pot = new THREE.Mesh(
                        new THREE.CylinderGeometry(0.08, 0.06, 0.12, 8),
                        new THREE.MeshPhongMaterial({ color: 0x8b4513 })
                    );
                    pot.position.y = 0.06;
                    group.add(pot);

                    // Plant
                    const plant = new THREE.Mesh(
                        new THREE.SphereGeometry(0.08, 8, 8),
                        new THREE.MeshPhongMaterial({ color: 0x4ade80 })
                    );
                    plant.position.y = 0.18;
                    group.add(plant);
                    break;

                case 'rug':
                    // Simple rug on the ground
                    const rug = new THREE.Mesh(
                        new THREE.CircleGeometry(0.4, 32),
                        new THREE.MeshPhongMaterial({ color: 0x9d4edd, side: THREE.DoubleSide })
                    );
                    rug.rotation.x = -Math.PI / 2;
                    rug.position.y = 0.01;
                    rug.position.x = 0;
                    rug.position.z = 0;
                    group.add(rug);
                    break;

                case 'poster':
                    // Wall poster (floating plane) - moved to side, muted color
                    const poster = new THREE.Mesh(
                        new THREE.PlaneGeometry(0.3, 0.4),
                        new THREE.MeshPhongMaterial({ color: 0x444444, side: THREE.DoubleSide })
                    );
                    poster.position.set(0.6, 0.5, -0.6);
                    poster.rotation.y = -0.3;
                    group.add(poster);
                    break;

                case 'smallTable':
                    // Simple table
                    const tableTop = new THREE.Mesh(
                        new THREE.BoxGeometry(0.4, 0.05, 0.3),
                        new THREE.MeshPhongMaterial({ color: 0x8b4513 })
                    );
                    tableTop.position.y = 0.25;
                    group.add(tableTop);

                    const leg1 = new THREE.Mesh(
                        new THREE.BoxGeometry(0.03, 0.25, 0.03),
                        new THREE.MeshPhongMaterial({ color: 0x654321 })
                    );
                    leg1.position.set(-0.15, 0.125, -0.1);
                    group.add(leg1);

                    const leg2 = leg1.clone();
                    leg2.position.set(0.15, 0.125, -0.1);
                    group.add(leg2);

                    const leg3 = leg1.clone();
                    leg3.position.set(-0.15, 0.125, 0.1);
                    group.add(leg3);

                    const leg4 = leg1.clone();
                    leg4.position.set(0.15, 0.125, 0.1);
                    group.add(leg4);
                    break;

                case 'betterLamp':
                    // Modern lamp
                    const modernLampBase = new THREE.Mesh(
                        new THREE.CylinderGeometry(0.06, 0.08, 0.05),
                        new THREE.MeshPhongMaterial({ color: 0x333333 })
                    );
                    modernLampBase.position.y = 0.025;
                    group.add(modernLampBase);

                    const modernLampPole = new THREE.Mesh(
                        new THREE.CylinderGeometry(0.015, 0.015, 0.5),
                        new THREE.MeshPhongMaterial({ color: 0x444444 })
                    );
                    modernLampPole.position.y = 0.275;
                    group.add(modernLampPole);

                    const modernLampHead = new THREE.Mesh(
                        new THREE.SphereGeometry(0.1, 16, 16, 0, Math.PI * 2, 0, Math.PI / 2),
                        new THREE.MeshPhongMaterial({ color: 0xffffff, emissive: 0xffffff, emissiveIntensity: 0.2 })
                    );
                    modernLampHead.position.y = 0.55;
                    group.add(modernLampHead);

                    const modernLight = new THREE.PointLight(0xffffff, 0.6, 2.5);
                    modernLight.position.y = 0.5;
                    group.add(modernLight);
                    break;

                case 'bookshelf':
                    // Bookshelf
                    const shelf = new THREE.Mesh(
                        new THREE.BoxGeometry(0.5, 0.6, 0.15),
                        new THREE.MeshPhongMaterial({ color: 0x8b4513 })
                    );
                    shelf.position.y = 0.3;
                    group.add(shelf);

                    // Books
                    const bookColors = [0xff0000, 0x00ff00, 0x0000ff, 0xffff00, 0xff00ff];
                    for (let i = 0; i < 5; i++) {
                        const book = new THREE.Mesh(
                            new THREE.BoxGeometry(0.04, 0.18, 0.12),
                            new THREE.MeshPhongMaterial({ color: bookColors[i] })
                        );
                        book.position.set(-0.15 + i * 0.08, 0.45, 0);
                        group.add(book);
                    }
                    break;

                case 'smallTV':
                    // TV stand
                    const tvStand = new THREE.Mesh(
                        new THREE.BoxGeometry(0.5, 0.2, 0.3),
                        new THREE.MeshPhongMaterial({ color: 0x444444 })
                    );
                    tvStand.position.y = 0.1;
                    group.add(tvStand);

                    // TV screen
                    const tvScreen = new THREE.Mesh(
                        new THREE.BoxGeometry(0.4, 0.25, 0.05),
                        new THREE.MeshPhongMaterial({ color: 0x111111 })
                    );
                    tvScreen.position.y = 0.35;
                    group.add(tvScreen);

                    // Screen glow - dimmed and positioned behind screen
                    const tvGlow = new THREE.Mesh(
                        new THREE.PlaneGeometry(0.3, 0.15),
                        new THREE.MeshBasicMaterial({ color: 0x223344, transparent: true, opacity: 0.5 })
                    );
                    tvGlow.position.set(0, 0.35, 0.026);
                    group.add(tvGlow);
                    break;

                case 'comfyChair':
                    // Chair base
                    const chairBase = new THREE.Mesh(
                        new THREE.BoxGeometry(0.35, 0.1, 0.35),
                        new THREE.MeshPhongMaterial({ color: 0x654321 })
                    );
                    chairBase.position.y = 0.05;
                    group.add(chairBase);

                    // Chair back
                    const chairBack = new THREE.Mesh(
                        new THREE.BoxGeometry(0.35, 0.4, 0.08),
                        new THREE.MeshPhongMaterial({ color: 0x8b4513 })
                    );
                    chairBack.position.set(0, 0.3, -0.15);
                    group.add(chairBack);

                    // Cushion
                    const cushion = new THREE.Mesh(
                        new THREE.BoxGeometry(0.3, 0.08, 0.3),
                        new THREE.MeshPhongMaterial({ color: 0xff6b9d })
                    );
                    cushion.position.y = 0.14;
                    group.add(cushion);
                    break;

                case 'coffeeTable':
                    // Coffee table
                    const coffeeTableTop = new THREE.Mesh(
                        new THREE.CylinderGeometry(0.25, 0.25, 0.03, 16),
                        new THREE.MeshPhongMaterial({ color: 0x8b4513 })
                    );
                    coffeeTableTop.position.y = 0.2;
                    group.add(coffeeTableTop);

                    // Legs
                    for (let i = 0; i < 3; i++) {
                        const legAngle = (i / 3) * Math.PI * 2;
                        const leg = new THREE.Mesh(
                            new THREE.CylinderGeometry(0.015, 0.01, 0.2),
                            new THREE.MeshPhongMaterial({ color: 0x654321 })
                        );
                        leg.position.set(
                            Math.cos(legAngle) * 0.15,
                            0.1,
                            Math.sin(legAngle) * 0.15
                        );
                        group.add(leg);
                    }

                    // Coffee cup
                    const cup = new THREE.Mesh(
                        new THREE.CylinderGeometry(0.03, 0.025, 0.05),
                        new THREE.MeshPhongMaterial({ color: 0xffffff })
                    );
                    cup.position.y = 0.24;
                    group.add(cup);
                    break;

                default:
                    return null;
            }

            return group;
        }

        function updateEnvironmentUI() {
            const envWealth = document.getElementById('envWealth');
            const envHealth = document.getElementById('envHealth');
            const envItems = document.getElementById('envItems');

            // P1-027: Environment Tier System
            const newTier = getEnvironmentTier(growthState.wealthScore);
            if (newTier !== currentEnvironmentTier) {
                currentEnvironmentTier = newTier;
                transitionEnvironmentTier(newTier);
            }

            if (envWealth) {
                const tier = ENVIRONMENT_TIERS[currentEnvironmentTier];
                envWealth.textContent = `${tier.emoji} ${tier.name}`;
            }

            if (envHealth) {
                const healthTiers = ['GLOOMY', 'BRIGHT', 'SUNNY'];
                const healthIndex = Math.min(2, Math.floor(growthState.healthScore / 33));
                envHealth.textContent = healthTiers[healthIndex];
            }

            if (envItems) {
                const unlockedList = Array.from(unlockedItems).slice(-5);
                const itemEmojis = {
                    'basicLight': 'üí°', 'smallPlant': 'üå±', 'rug': 'üß∂', 'poster': 'üñºÔ∏è', 'smallTable': 'üõèÔ∏è',
                    'betterLamp': 'üõãÔ∏è', 'bookshelf': 'üìö', 'smallTV': 'üì∫', 'comfyChair': 'ü™ë', 'coffeeTable': '‚òï'
                };

                if (unlockedList.length > 0) {
                    envItems.innerHTML = unlockedList.map(item =>
                        `<span class="env-item">${itemEmojis[item] || '‚ú®'} ${item.replace(/([A-Z])/g, ' $1').trim().toUpperCase()}</span>`
                    ).join('');
                }
            }
        }

        // P1-027: Get environment tier based on wealth
        function getEnvironmentTier(wealthScore) {
            for (let i = ENVIRONMENT_TIERS.length - 1; i >= 0; i--) {
                if (wealthScore >= ENVIRONMENT_TIERS[i].minWealth) {
                    return i;
                }
            }
            return 0;
        }

        // P1-027: Smooth transition between environment tiers
        function transitionEnvironmentTier(tierIndex) {
            const tier = ENVIRONMENT_TIERS[tierIndex];

            // Show notification
            showNotification(`üè† ENVIRONMENT UPGRADED: ${tier.emoji} ${tier.name}!`);

            // Animate background color transition
            const startColor = scene.background.clone();
            const endColor = new THREE.Color(tier.bgColor);
            const duration = 2000; // 2 seconds
            const startTime = Date.now();

            function animateTransition() {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const ease = 1 - Math.pow(1 - progress, 3); // Ease out cubic

                scene.background.lerpColors(startColor, endColor, ease);

                // Update fog if enabled
                if (tier.fog && scene.fog) {
                    scene.fog.color.lerpColors(startColor, endColor, ease);
                }

                if (progress < 1) {
                    requestAnimationFrame(animateTransition);
                } else {
                    // Update lighting intensity
                    scene.traverse((child) => {
                        if (child.isLight && child.type === 'AmbientLight') {
                            child.intensity = tier.lighting;
                        }
                    });
                }
            }

            animateTransition();

            // Add particle burst effect
            createTierUpgradeParticles();
        }

        // P1-027: Particle burst on tier upgrade
        function createTierUpgradeParticles() {
            const particleCount = 50;
            const geometry = new THREE.BufferGeometry();
            const positions = new Float32Array(particleCount * 3);
            const velocities = [];

            for (let i = 0; i < particleCount; i++) {
                positions[i * 3] = 0;
                positions[i * 3 + 1] = 0;
                positions[i * 3 + 2] = 0;

                velocities.push({
                    x: (Math.random() - 0.5) * 0.1,
                    y: Math.random() * 0.1 + 0.05,
                    z: (Math.random() - 0.5) * 0.1
                });
            }

            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));

            const material = new THREE.PointsMaterial({
                color: 0xffd700,
                size: 0.05,
                transparent: true,
                opacity: 1
            });

            const particles = new THREE.Points(geometry, material);
            scene.add(particles);

            const startTime = Date.now();
            const duration = 2000;

            function animateParticles() {
                const elapsed = Date.now() - startTime;
                const progress = elapsed / duration;

                if (progress >= 1) {
                    scene.remove(particles);
                    geometry.dispose();
                    material.dispose();
                    return;
                }

                const positions = particles.geometry.attributes.position.array;
                for (let i = 0; i < particleCount; i++) {
                    positions[i * 3] += velocities[i].x;
                    positions[i * 3 + 1] += velocities[i].y;
                    positions[i * 3 + 2] += velocities[i].z;
                    velocities[i].y -= 0.002; // Gravity
                }
                particles.geometry.attributes.position.needsUpdate = true;
                material.opacity = 1 - progress;

                requestAnimationFrame(animateParticles);
            }

            animateParticles();
        }

        // Growth System
        function updateGrowth() {
            growthState.combinedScore = Math.round((growthState.healthScore + growthState.wealthScore) / 2);

            // Determine level
            let newLevel = 1;
            for (let i = 4; i >= 1; i--) {
                if (growthState.combinedScore >= LEVELS[i].minScore) {
                    newLevel = i;
                    break;
                }
            }

            if (newLevel !== growthState.level) {
                growthState.level = newLevel;
                showNotification(`üéâ LEVEL UP! NOW ${LEVELS[newLevel].name}!`);
            }

            growthState.stage = LEVELS[growthState.level].name.toLowerCase();

            // Update UI
            document.getElementById('currentLevel').textContent = growthState.level;
            document.getElementById('stageLabel').textContent = `${LEVELS[growthState.level].emoji} ${LEVELS[growthState.level].name}`;
            document.getElementById('growthScore').textContent = growthState.combinedScore;

            const progressInLevel = (growthState.combinedScore - LEVELS[growthState.level].minScore) /
                (LEVELS[growthState.level].maxScore - LEVELS[growthState.level].minScore) * 100;
            document.getElementById('growthProgress').style.width = Math.min(100, Math.max(0, progressInLevel)) + '%';

            // Update markers
            document.querySelectorAll('.level-marker').forEach(marker => {
                const markerLevel = parseInt(marker.dataset.level);
                marker.classList.remove('active', 'completed');

                if (markerLevel === growthState.level) {
                    marker.classList.add('active');
                } else if (markerLevel < growthState.level) {
                    marker.classList.add('completed');
                }
            });

            // Update character scale - FIXED at 1.0 (growth scaling removed)
            if (character) {
                // VRM now displays at full scale regardless of growth state
                character.scale.set(0.4, 0.4, 0.4);
            }

            // Update environment
            checkAndUnlockItems(growthState.wealthScore);
        }

        // Modal Functions
        function openModal(type) {
            document.getElementById(type + 'Modal').classList.add('active');
            document.getElementById('modal' + type.charAt(0).toUpperCase() + type.slice(1) + 'Score').textContent =
                growthState[type + 'Score'] + '/100';
        }

        function closeModal(type) {
            document.getElementById(type + 'Modal').classList.remove('active');
        }

        // Activity Logging
        function logHealthActivity() {
            const type = document.getElementById('healthActivityType').value;
            const value = parseInt(document.getElementById('healthActivityValue').value);

            if (!value) return;

            // Update health score
            growthState.healthScore = Math.min(100, growthState.healthScore + Math.floor(value / 10));
            document.getElementById('healthScoreValue').textContent = growthState.healthScore;
            document.getElementById('healthBar').style.width = growthState.healthScore + '%';

            updateGrowth();
            showNotification(`‚úÖ LOGGED ${type.toUpperCase()}: ${value}`);
            document.getElementById('healthActivityValue').value = '';
        }

        function logWealthActivity() {
            const type = document.getElementById('wealthActivityType').value;
            const value = parseInt(document.getElementById('wealthActivityValue').value);

            if (!value) return;

            // Update wealth score
            if (type === 'income' || type === 'gig' || type === 'investment') {
                const oldScore = growthState.wealthScore;
                growthState.wealthScore = Math.min(100, growthState.wealthScore + Math.floor(value / 100));

                // Check for new unlocks if score increased
                if (growthState.wealthScore > oldScore) {
                    checkAndUnlockItems(growthState.wealthScore);
                }
            }

            document.getElementById('wealthScoreValue').textContent = growthState.wealthScore;
            document.getElementById('wealthBar').style.width = growthState.wealthScore + '%';

            updateGrowth();
            showNotification(`‚úÖ LOGGED ${type.toUpperCase()}: $${value}`);
            document.getElementById('wealthActivityValue').value = '';
        }

        // Confession System
        let confessions = JSON.parse(localStorage.getItem('mc_confessions') || '[]');
        let confessionLikes = JSON.parse(localStorage.getItem('mc_confession_likes') || '{}');
        const currentUser = 'anonymous_' + Math.random().toString(36).substr(2, 6);

        const confessionCategories = {
            health: { name: 'üí™ HEALTH', color: '#4ade80' },
            wealth: { name: 'üí∞ WEALTH', color: '#fbbf24' },
            mindset: { name: 'üß† MINDSET', color: '#a78bfa' },
            relationship: { name: '‚ù§Ô∏è RELATIONSHIPS', color: '#f472b6' },
            work: { name: 'üíº WORK', color: '#60a5fa' }
        };

        function submitConfession() {
            const input = document.getElementById('confessionInput');
            const category = document.getElementById('confessionCategory').value;
            const text = input.value.trim();

            if (!text || text.length < 10) {
                showNotification('‚ùå MIN 10 CHARACTERS!');
                return;
            }

            const confession = {
                id: Date.now().toString(),
                text: text,
                category: category,
                timestamp: Date.now(),
                likes: 0,
                author: currentUser
            };

            confessions.unshift(confession);
            localStorage.setItem('mc_confessions', JSON.stringify(confessions));

            input.value = '';
            document.getElementById('charCount').textContent = '0';

            renderConfessions();
            showNotification('‚úÖ CONFESSION POSTED!');
        }

        function toggleLike(confessionId) {
            const confession = confessions.find(c => c.id === confessionId);
            if (!confession) return;

            const likeKey = `${currentUser}_${confessionId}`;
            const hasLiked = confessionLikes[likeKey];

            if (hasLiked) {
                confession.likes--;
                delete confessionLikes[likeKey];
            } else {
                confession.likes++;
                confessionLikes[likeKey] = true;
            }

            localStorage.setItem('mc_confession_likes', JSON.stringify(confessionLikes));
            localStorage.setItem('mc_confessions', JSON.stringify(confessions));
            renderConfessions();
        }

        function renderConfessions() {
            const feed = document.getElementById('confessionFeed');
            const count = document.getElementById('confessionCount');

            count.textContent = confessions.length;

            if (confessions.length === 0) {
                feed.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #666; font-family: var(--font-pixel); font-size: 8px;">
                        üìù NO CONFESSIONS YET. BE THE FIRST!
                    </div>
                `;
                return;
            }

            feed.innerHTML = confessions.map(confession => {
                const cat = confessionCategories[confession.category];
                const likeKey = `${currentUser}_${confession.id}`;
                const hasLiked = confessionLikes[likeKey];
                const timeAgo = getTimeAgo(confession.timestamp);

                return `
                    <div class="confession-card">
                        <span class="confession-category-tag" style="background: ${cat.color}20; color: ${cat.color}">
                            ${cat.name}
                        </span>
                        <div class="confession-text">${escapeHtml(confession.text)}</div>
                        <div class="confession-footer">
                            <span>${timeAgo} ‚Ä¢ ${confession.likes} LIKES</span>
                            <div class="confession-actions">
                                <button class="action-btn ${hasLiked ? 'liked' : ''}" onclick="toggleLike('${confession.id}')">
                                    ${hasLiked ? '‚ù§Ô∏è' : 'ü§ç'} ${confession.likes}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Challenge System
        let challenges = JSON.parse(localStorage.getItem('mc_challenges') || '[]');

        const challengeTypes = {
            steps: { name: 'üëü STEP BATTLE', icon: 'üëü', unit: 'STEPS' },
            savings: { name: 'üí∞ SAVINGS RACE', icon: 'üí∞', unit: '$' },
            workout: { name: 'üí™ WORKOUT STREAK', icon: 'üí™', unit: 'SESSIONS' },
            sleep: { name: 'üò¥ SLEEP GOAL', icon: 'üò¥', unit: 'HOURS' }
        };

        function showChallengeModal() {
            document.getElementById('challengeModal').classList.add('active');
        }

        function hideChallengeModal() {
            document.getElementById('challengeModal').classList.remove('active');
        }

        function createChallenge() {
            const type = document.getElementById('challengeType').value;
            const friend = document.getElementById('challengeFriend').value.trim();
            const goal = parseInt(document.getElementById('challengeGoal').value);
            const duration = parseInt(document.getElementById('challengeDuration').value);

            if (!friend || !goal) {
                showNotification('‚ùå FILL ALL FIELDS!');
                return;
            }

            const challenge = {
                id: Date.now().toString(),
                type: type,
                opponent: friend,
                goal: goal,
                duration: duration,
                createdAt: Date.now(),
                myProgress: 0,
                theirProgress: 0,
                status: 'active'
            };

            challenges.push(challenge);
            localStorage.setItem('mc_challenges', JSON.stringify(challenges));

            hideChallengeModal();
            renderChallenges();
            showNotification('üèÜ CHALLENGE CREATED!');

            document.getElementById('challengeFriend').value = '';
            document.getElementById('challengeGoal').value = '';
        }

        function renderChallenges() {
            const list = document.getElementById('challengeList');
            const active = challenges.filter(c => c.status === 'active');

            if (active.length === 0) {
                list.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #666; font-family: var(--font-pixel); font-size: 8px;">
                        üèÜ NO ACTIVE CHALLENGES. CREATE ONE!
                    </div>
                `;
                return;
            }

            list.innerHTML = active.map(c => {
                const type = challengeTypes[c.type];
                const myPercent = Math.min(100, (c.myProgress / c.goal) * 100);
                const daysLeft = Math.ceil((c.createdAt + (c.duration * 24 * 60 * 60 * 1000) - Date.now()) / (24 * 60 * 60 * 1000));

                return `
                    <div class="challenge-card">
                        <div class="challenge-title">${type.name}</div>
                        <div style="font-size: 14px; color: #888; margin-bottom: 0.5rem;">
                            VS ${c.opponent} ‚Ä¢ ${daysLeft > 0 ? daysLeft + ' DAYS LEFT' : 'ENDED'}
                        </div>
                        <div style="font-size: 12px; color: var(--pixel-cyan); margin-bottom: 0.5rem;">
                            GOAL: ${c.goal} ${type.unit}
                        </div>
                        <div class="challenge-progress-bar">
                            <div class="challenge-progress-fill" style="width: ${myPercent}%"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 0.5rem; font-size: 12px;">
                            <span>YOU: ${c.myProgress}</span>
                            <span>THEM: ${c.theirProgress}</span>
                        </div>
                        <button onclick="addChallengeProgress('${c.id}')" class="pixel-btn" style="margin-top: 0.5rem; width: 100%;">
                            ‚ûï ADD PROGRESS
                        </button>
                    </div>
                `;
            }).join('');
        }

        function addChallengeProgress(challengeId) {
            const challenge = challenges.find(c => c.id === challengeId);
            if (!challenge) return;

            const increment = Math.floor(Math.random() * 10) + 5;
            challenge.myProgress = Math.min(challenge.goal, challenge.myProgress + increment);

            // Simulate opponent progress
            challenge.theirProgress = Math.min(challenge.goal, challenge.theirProgress + Math.floor(Math.random() * 8) + 3);

            if (challenge.myProgress >= challenge.goal) {
                challenge.status = 'completed';
                showNotification('üéâ YOU WON THE CHALLENGE!');
            }

            localStorage.setItem('mc_challenges', JSON.stringify(challenges));
            renderChallenges();
        }

        // Utilities
        function getTimeAgo(timestamp) {
            const seconds = Math.floor((Date.now() - timestamp) / 1000);
            if (seconds < 60) return 'JUST NOW';
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes}M AGO`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours}H AGO`;
            return `${Math.floor(hours / 24)}D AGO`;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slide-out 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // P1-030: Light/Dark Mode Toggle
        let currentTheme = localStorage.getItem('mc_theme') || 'dark';
        document.documentElement.setAttribute('data-theme', currentTheme);

        function toggleTheme() {
            currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', currentTheme);
            localStorage.setItem('mc_theme', currentTheme);
            showNotification(currentTheme === 'light' ? '‚òÄÔ∏è LIGHT MODE' : 'üåô DARK MODE');
        }

        // Character counter
        document.getElementById('confessionInput')?.addEventListener('input', (e) => {
            document.getElementById('charCount').textContent = e.target.value.length;
        });

        // Close modals on outside click
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) overlay.classList.remove('active');
            });
        });

        // Initialize
        window.addEventListener('load', () => {
            initCharacter();
            renderConfessions();
            renderChallenges();
            updateGrowth();
            loadDailyQuiz();
            checkAchievements();
            renderAchievements();
            requestNotificationPermission();
        });

        window.addEventListener('resize', () => {
            if (camera && renderer) {
                const container = document.getElementById('character-canvas');
                camera.aspect = container.clientWidth / container.clientHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(container.clientWidth, container.clientHeight);
            }
        });

        // Cleanup
        window.addEventListener('beforeunload', () => {
            if (poseInterval) clearInterval(poseInterval);
        });

        // ============================================
        // P0-011: MEDITATION SYSTEM
        // ============================================
        let isMeditating = false;
        let meditationAnimation = null;
        let preMeditationPose = null;

        // Meditation pose - cross-legged sitting
        const meditationPose = {
            name: 'MEDITATE',
            emoji: 'üßò',
            rotation: { x: -0.1, y: 0, z: 0 },
            position: { y: -0.35 }
        };

        function toggleMeditation() {
            const btn = document.getElementById('meditateBtn');

            if (isMeditating) {
                // Stop meditation
                isMeditating = false;
                btn.classList.remove('active');
                btn.innerHTML = 'üßò MEDITATE';

                // Clear meditation animation
                if (meditationAnimation) {
                    cancelAnimationFrame(meditationAnimation);
                    meditationAnimation = null;
                }

                // Reset position
                if (character) {
                    character.position.x = 0;
                    character.position.z = 0;
                    character.scale.set(0.4, 0.4, 0.4);
                }

                // Return to previous pose or idle
                if (preMeditationPose !== null) {
                    applyPose(preMeditationPose);
                } else {
                    applyPose(0); // Return to idle
                }

                // Resume auto pose rotation
                startPoseRotation();
                showNotification('üßò MEDITATION ENDED');

            } else {
                // Start meditation
                isMeditating = true;
                preMeditationPose = currentPose;
                btn.classList.add('active');
                btn.innerHTML = 'üßò STOP';

                // Stop auto pose rotation
                if (poseInterval) {
                    clearInterval(poseInterval);
                    poseInterval = null;
                }

                // Reset position for meditation
                if (character) {
                    character.position.x = 0;
                    character.position.z = 0;
                    character.scale.set(0.4, 0.4, 0.4);
                }

                // Apply meditation pose with smooth transition
                applyMeditationPose();
                showNotification('üßò MEDITATION STARTED - BREATHE...');
            }
        }

        function applyMeditationPose() {
            if (!character) return;

            const duration = 1000; // 1 second transition
            const startRot = character.rotation.clone();
            const startPos = character.position.clone();
            const startTime = Date.now();

            function updateMeditationPose() {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const ease = 1 - Math.pow(1 - progress, 3);

                character.rotation.x = startRot.x + (meditationPose.rotation.x - startRot.x) * ease;
                character.rotation.y = startRot.y + (meditationPose.rotation.y - startRot.y) * ease;
                character.rotation.z = startRot.z + (meditationPose.rotation.z - startRot.z) * ease;

                // FIXED SCALE: Removed growth level scaling
                character.position.y = startPos.y + (meditationPose.position.y - startPos.y) * ease;

                if (progress < 1) {
                    requestAnimationFrame(updateMeditationPose);
                } else {
                    // Start breathing animation
                    startMeditationBreathing();
                }
            }

            // Update indicator
            const indicator = document.getElementById('movementIndicator');
            if (indicator) {
                indicator.innerHTML = `<span>${meditationPose.emoji}</span><span>${meditationPose.name}</span>`;
            }

            updateMeditationPose();
        }

        function startMeditationBreathing() {
            if (!isMeditating || !character) return;

            const breatheSpeed = 0.001; // Slow breathing
            const breatheStart = Date.now();

            function breathe() {
                if (!isMeditating) return;

                const elapsed = Date.now() - breatheStart;
                // Sine wave for breathing - inhale 4s, exhale 4s
                const breatheCycle = Math.sin(elapsed * breatheSpeed);

                // FIXED SCALE: Breathing animation uses fixed base scale
                const baseScale = 0.4;
                const breatheScale = baseScale + (breatheCycle * 0.02);
                character.scale.set(breatheScale, breatheScale, breatheScale);

                // Subtle rotation for zen effect
                character.rotation.y = Math.sin(elapsed * 0.0003) * 0.05;

                meditationAnimation = requestAnimationFrame(breathe);
            }

            breathe();
        }

        // ============================================
        // P0-012: HOLIDAY COSTUME SYSTEM
        // ============================================
        let currentHoliday = localStorage.getItem('mc_holiday') || 'none';
        let holidayOverlay = null;

        const holidayThemes = {
            newyear: {
                name: 'NEW YEAR',
                emoji: 'üéÜ',
                primaryColor: '#ffd700',
                secondaryColor: '#ff6b6b',
                bgGradient: 'linear-gradient(135deg, #1a1a2e 0%, #2a1a1a 100%)',
                particleEmoji: '‚ú®',
                costumeColor: 0xffd700
            },
            valentine: {
                name: 'VALENTINE\'S',
                emoji: 'üíù',
                primaryColor: '#ff6b9d',
                secondaryColor: '#ff1744',
                bgGradient: 'linear-gradient(135deg, #1a1a2e 0%, #2a1a2a 100%)',
                particleEmoji: 'üíï',
                costumeColor: 0xff6b9d
            },
            lunar: {
                name: 'LUNAR NEW YEAR',
                emoji: 'üßß',
                primaryColor: '#ff0000',
                secondaryColor: '#ffd700',
                bgGradient: 'linear-gradient(135deg, #1a1a2e 0%, #2a1a1a 100%)',
                particleEmoji: 'üèÆ',
                costumeColor: 0xff0000
            },
            halloween: {
                name: 'HALLOWEEN',
                emoji: 'üéÉ',
                primaryColor: '#ff8c42',
                secondaryColor: '#7b1fa2',
                bgGradient: 'linear-gradient(135deg, #1a1a2e 0%, #1a0a1a 100%)',
                particleEmoji: 'ü¶á',
                costumeColor: 0xff8c42
            },
            christmas: {
                name: 'CHRISTMAS',
                emoji: 'üéÑ',
                primaryColor: '#4caf50',
                secondaryColor: '#d32f2f',
                bgGradient: 'linear-gradient(135deg, #0a1a0a 0%, #1a1a2e 100%)',
                particleEmoji: 'üéÖ',
                costumeColor: 0x4caf50
            },
            birthday: {
                name: 'BIRTHDAY',
                emoji: 'üéÇ',
                primaryColor: '#9c27b0',
                secondaryColor: '#ffd700',
                bgGradient: 'linear-gradient(135deg, #1a1a2e 0%, #2a1a3a 100%)',
                particleEmoji: 'üéà',
                costumeColor: 0x9c27b0
            },
            none: {
                name: 'NO COSTUME',
                emoji: '‚ùå',
                primaryColor: '#00d4ff',
                secondaryColor: '#9d4edd',
                bgGradient: 'linear-gradient(135deg, #1a1a2e 0%, #0f0f1a 100%)',
                particleEmoji: '',
                costumeColor: null
            }
        };

        // P1-024: Color Menu Functions
        let currentCharacterColor = localStorage.getItem('mc_character_color') || '#00d4ff';

        function toggleColorMenu() {
            const menu = document.getElementById('colorMenu');
            menu.classList.toggle('active');
            document.getElementById('holidayMenu').classList.remove('active');
        }

        function setCharacterColor(color) {
            currentCharacterColor = color;
            localStorage.setItem('mc_character_color', color);

            // Apply color to character
            if (character) {
                character.traverse((child) => {
                    if (child.isMesh && child.material) {
                        const newColor = new THREE.Color(color);
                        child.material.emissive = newColor;
                        child.material.emissiveIntensity = 0.3;
                    }
                });
            }

            document.getElementById('colorMenu').classList.remove('active');
            showNotification(`üé® COLOR CHANGED!`);
        }

        function toggleHolidayMenu() {
            const menu = document.getElementById('holidayMenu');
            menu.classList.toggle('active');
            document.getElementById('colorMenu').classList.remove('active');

            // Update active state
            document.querySelectorAll('.holiday-option').forEach(opt => {
                opt.classList.remove('active');
                if (opt.dataset.holiday === currentHoliday) {
                    opt.classList.add('active');
                }
            });
        }

        function selectHoliday(holiday) {
            currentHoliday = holiday;
            localStorage.setItem('mc_holiday', holiday);

            const theme = holidayThemes[holiday];

            // Close menu
            document.getElementById('holidayMenu').classList.remove('active');

            // Apply holiday theme
            applyHolidayTheme(theme);

            if (holiday !== 'none') {
                showNotification(`${theme.emoji} ${theme.name} COSTUME EQUIPPED!`);
            } else {
                showNotification('‚ùå COSTUME REMOVED');
            }
        }

        function applyHolidayTheme(theme) {
            // Update CSS variables for theme
            document.documentElement.style.setProperty('--pixel-cyan', theme.primaryColor);

            // Update scene background
            if (scene) {
                scene.background = new THREE.Color(parseInt(theme.primaryColor.replace('#', '0x')) || 0x1a1a2e);
            }

            // Apply costume color to character
            if (character && theme.costumeColor) {
                character.traverse((child) => {
                    if (child.isMesh && child.material) {
                        // Store original color if not stored
                        if (!child.userData.originalColor) {
                            child.userData.originalColor = child.material.color.clone();
                        }

                        // Apply holiday tint
                        const holidayColor = new THREE.Color(theme.costumeColor);
                        child.material.color.lerp(holidayColor, 0.3);
                        child.material.emissive = holidayColor;
                        child.material.emissiveIntensity = 0.2;
                    }
                });
            } else if (character && theme.name === 'NO COSTUME') {
                // Restore original colors
                character.traverse((child) => {
                    if (child.isMesh && child.material && child.userData.originalColor) {
                        child.material.color.copy(child.userData.originalColor);
                        child.material.emissive = new THREE.Color(0x000000);
                        child.material.emissiveIntensity = 0;
                    }
                });
            }

            // Update UI accents
            document.querySelectorAll('.pixel-btn').forEach(btn => {
                if (!btn.classList.contains('meditate') && !btn.classList.contains('holiday')) {
                    btn.style.borderColor = theme.primaryColor;
                    btn.style.color = theme.primaryColor;
                }
            });

            // Update progress bars
            document.querySelectorAll('.pixel-progress-fill').forEach(bar => {
                bar.style.background = `linear-gradient(90deg, ${theme.primaryColor}, ${theme.secondaryColor})`;
            });

            // Add floating particles for holiday
            if (theme.particleEmoji && holiday !== 'none') {
                addHolidayParticles(theme);
            } else {
                removeHolidayParticles();
            }
        }

        function addHolidayParticles(theme) {
            removeHolidayParticles();

            const container = document.getElementById('character-canvas');
            if (!container) return;

            const particleContainer = document.createElement('div');
            particleContainer.id = 'holiday-particles';
            particleContainer.style.cssText = `
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                pointer-events: none;
                overflow: hidden;
                z-index: 10;
            `;

            // Create floating particles
            for (let i = 0; i < 12; i++) {
                const particle = document.createElement('div');
                particle.textContent = theme.particleEmoji;
                particle.style.cssText = `
                    position: absolute;
                    font-size: ${20 + Math.random() * 20}px;
                    left: ${Math.random() * 100}%;
                    top: -50px;
                    opacity: 0.6;
                    animation: float-down ${5 + Math.random() * 5}s linear infinite;
                    animation-delay: ${Math.random() * 5}s;
                `;
                particleContainer.appendChild(particle);
            }

            // Add float animation
            if (!document.getElementById('holiday-anim')) {
                const style = document.createElement('style');
                style.id = 'holiday-anim';
                style.textContent = `
                    @keyframes float-down {
                        0% { transform: translateY(0) rotate(0deg); opacity: 0; }
                        10% { opacity: 0.6; }
                        90% { opacity: 0.6; }
                        100% { transform: translateY(450px) rotate(360deg); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }

            container.style.position = 'relative';
            container.appendChild(particleContainer);
        }

        function removeHolidayParticles() {
            const existing = document.getElementById('holiday-particles');
            if (existing) existing.remove();
        }

        // Initialize holiday theme on load
        if (currentHoliday && currentHoliday !== 'none') {
            window.addEventListener('load', () => {
                setTimeout(() => {
                    applyHolidayTheme(holidayThemes[currentHoliday]);
                }, 1000); // Wait for character to load
            });
        }

        // Close holiday menu when clicking outside
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('holidayMenu');
            const btn = document.getElementById('holidayBtn');
            if (menu && btn && !menu.contains(e.target) && !btn.contains(e.target)) {
                menu.classList.remove('active');
            }
        });
    </script>
</body>
</html>
?v=2
